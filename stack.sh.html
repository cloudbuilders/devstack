<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>stack.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>stack.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.7: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 6253 2010-03-02 00:24:53Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p><strong>stack.sh</strong> is an opinionated openstack developer installation.</p>
</td><td class=code><div class=highlight><pre>
<span class="c">#!/usr/bin/env bash</span>


</pre></div></td></tr><tr><td class=docs>
<p>This script installs and configures <em>nova</em>, <em>glance</em>, <em>horizon</em> and <em>keystone</em></p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>This script allows you to specify configuration options of what git
repositories to use, enabled services, network configuration and various
passwords.  If you are crafty you can run the script on multiple nodes using
shared settings for common resources (mysql, rabbitmq) and build a multi-node
developer install.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>To keep this script simple we assume you are running on an <strong>Ubuntu 11.10
Oneiric</strong> machine.  It should work in a VM or physical server.  Additionally
we put the list of <em>apt</em> and <em>pip</em> dependencies and other configuration files
in this repo.  So start by grabbing this script and the dependencies.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Learn more and get the most recent version at <a class="reference external" href="http://devstack.org">http://devstack.org</a></p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<div class="section" id="sanity-check">
<h1>Sanity Check</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Warn users who aren't on oneiric, but allow them to override check and attempt
installation with <tt class="docutils literal">FORCE=yes ./stack</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="nv">DISTRO</span><span class="o">=</span><span class="k">$(</span>lsb_release -c -s<span class="k">)</span>

<span class="k">if</span> <span class="o">[[</span> ! <span class="k">${</span><span class="nv">DISTRO</span><span class="k">}</span> <span class="o">=</span>~ <span class="o">(</span>oneiric<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: this script has only been tested on oneiric&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$FORCE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;If you wish to run this script anyway run with FORCE=yes&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Keep track of the current devstack directory.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TOP_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;$0&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>Import common functions</p>
</td><td class=code><div class=highlight><pre>
. <span class="nv">$TOP_DIR</span>/functions

</pre></div></td></tr><tr><td class=docs>
<p>stack.sh keeps the list of <strong>apt</strong> and <strong>pip</strong> dependencies in external
files, along with config templates and other useful files.  You can find these
in the <tt class="docutils literal">files</tt> directory (next to this script).  We will reference this
directory using the <tt class="docutils literal">FILES</tt> variable in this script.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">FILES</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/files
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$FILES</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: missing devstack/files - did you grab more than just stack.sh?&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>



</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="settings">
<h1>Settings</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>This script is customizable through setting environment variables.  If you
want to override a setting you can either:</p>
<pre class="literal-block">
export MYSQL_PASSWORD=anothersecret
./stack.sh
</pre>
<p>You can also pass options on a single line <tt class="docutils literal">MYSQL_PASSWORD=simple ./stack.sh</tt></p>
<p>Additionally, you can put any local variables into a <tt class="docutils literal">localrc</tt> file, like:</p>
<pre class="literal-block">
MYSQL_PASSWORD=anothersecret
MYSQL_USER=hellaroot
</pre>
<p>We try to have sensible defaults, so you should be able to run <tt class="docutils literal">./stack.sh</tt>
in most cases.</p>
<p>We support HTTP and HTTPS proxy servers via the usual environment variables
http_proxy and https_proxy.  They can be set in localrc if necessary or
on the command line:</p>
<pre class="literal-block">
http_proxy=http://proxy.example.com:3128/ ./stack.sh
</pre>
<p>We source our settings from <tt class="docutils literal">stackrc</tt>.  This file is distributed with devstack
and contains locations for what repositories to use.  If you want to use other
repositories and branches, you can add your own settings with another file called
<tt class="docutils literal">localrc</tt></p>
<p>If <tt class="docutils literal">localrc</tt> exists, then <tt class="docutils literal">stackrc</tt> will load those settings.  This is
useful for changing a branch or repository to test other versions.  Also you
can store your other settings like <strong>MYSQL_PASSWORD</strong> or <strong>ADMIN_PASSWORD</strong> instead
of letting devstack generate random ones for you. You can customize
which services to install as well in your localrc.</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> ./stackrc

</pre></div></td></tr><tr><td class=docs>
<p>Destination path for installation <tt class="docutils literal">DEST</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="nv">DEST</span><span class="o">=</span><span class="k">${</span><span class="nv">DEST</span><span class="k">:-</span><span class="p">/opt/stack</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Check to see if we are already running a stack.sh</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span><span class="nb">type</span> -p screen &gt;/dev/null <span class="o">&amp;&amp;</span> screen -ls | egrep -q <span class="s2">&quot;[0-9].stack&quot;</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;You are already running a stack.sh session.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;To rejoin this session type &#39;screen -x stack&#39;.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;To destroy this session, kill the running screen.&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>OpenStack is designed to be run as a regular user (Horizon will fail to run
as root, since apache refused to startup serve content from root user).  If
stack.sh is run as root, it automatically creates a stack user with
sudo privileges and runs as that user.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$EUID</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">ROOTSLEEP</span><span class="o">=</span><span class="k">${</span><span class="nv">ROOTSLEEP</span><span class="k">:-</span><span class="nv">10</span><span class="k">}</span>
    <span class="nb">echo</span> <span class="s2">&quot;You are running this script as root.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;In $ROOTSLEEP seconds, we will create a user &#39;stack&#39; and run as that user&quot;</span>
    sleep <span class="nv">$ROOTSLEEP</span>

</pre></div></td></tr><tr><td class=docs>
<p>since this script runs as a normal user, we need to give that user
ability to run sudo</p>
</td><td class=code><div class=highlight><pre>
    dpkg -l sudo <span class="o">||</span> apt_get update <span class="o">&amp;&amp;</span> apt_get install sudo

    <span class="k">if</span> ! getent passwd stack &gt;/dev/null; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Creating a user called stack&quot;</span>
        useradd -U -G sudo -s /bin/bash -d <span class="nv">$DEST</span> -m stack
    <span class="k">fi</span>

<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Giving stack user passwordless sudo priviledges&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>some uec images sudoers does not have a '#includedir'. add one.</p>
</td><td class=code><div class=highlight><pre>
    grep -q <span class="s2">&quot;^#includedir.*/etc/sudoers.d&quot;</span> /etc/sudoers <span class="o">||</span>
        <span class="nb">echo</span> <span class="s2">&quot;#includedir /etc/sudoers.d&quot;</span> &gt;&gt; /etc/sudoers
    <span class="o">(</span> <span class="nb">umask </span>226 <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;stack ALL=(ALL) NOPASSWD:ALL&quot;</span> <span class="se">\</span>
        &gt; /etc/sudoers.d/50_stack_sh <span class="o">)</span>

    <span class="nb">echo</span> <span class="s2">&quot;Copying files to stack user&quot;</span>
    <span class="nv">STACK_DIR</span><span class="o">=</span><span class="s2">&quot;$DEST/${PWD##*/}&quot;</span>
    cp -r -f -T <span class="s2">&quot;$PWD&quot;</span> <span class="s2">&quot;$STACK_DIR&quot;</span>
    chown -R stack <span class="s2">&quot;$STACK_DIR&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$SHELL_AFTER_RUN&quot;</span> !<span class="o">=</span> <span class="s2">&quot;no&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">exec </span>su -c <span class="s2">&quot;set -e; cd $STACK_DIR; bash stack.sh; bash&quot;</span> stack
    <span class="k">else</span>
<span class="k">        </span><span class="nb">exec </span>su -c <span class="s2">&quot;set -e; cd $STACK_DIR; bash stack.sh&quot;</span> stack
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">exit </span>1
<span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>We're not root, make sure sudo is available</p>
</td><td class=code><div class=highlight><pre>
    dpkg -l sudo
    die_if_error <span class="s2">&quot;Sudo is required.  Re-run stack.sh as root ONE TIME ONLY to set up sudo.&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>UEC images /etc/sudoers does not have a '#includedir'. add one.</p>
</td><td class=code><div class=highlight><pre>
    sudo grep -q <span class="s2">&quot;^#includedir.*/etc/sudoers.d&quot;</span> /etc/sudoers <span class="o">||</span>
        <span class="nb">echo</span> <span class="s2">&quot;#includedir /etc/sudoers.d&quot;</span> | sudo tee -a /etc/sudoers

</pre></div></td></tr><tr><td class=docs>
<p>Set up devstack sudoers</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">TEMPFILE</span><span class="o">=</span><span class="sb">`</span>mktemp<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;`whoami` ALL=(root) NOPASSWD:ALL&quot;</span> &gt;<span class="nv">$TEMPFILE</span>
    chmod 0440 <span class="nv">$TEMPFILE</span>
    sudo chown root:root <span class="nv">$TEMPFILE</span>
    sudo mv <span class="nv">$TEMPFILE</span> /etc/sudoers.d/50_stack_sh

</pre></div></td></tr><tr><td class=docs>
<p>Set up the rootwrap sudoers</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">TEMPFILE</span><span class="o">=</span><span class="sb">`</span>mktemp<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;$USER ALL=(root) NOPASSWD: /usr/local/bin/nova-rootwrap&quot;</span> &gt;<span class="nv">$TEMPFILE</span>
    chmod 0440 <span class="nv">$TEMPFILE</span>
    sudo chown root:root <span class="nv">$TEMPFILE</span>
    sudo mv <span class="nv">$TEMPFILE</span> /etc/sudoers.d/nova-rootwrap

</pre></div></td></tr><tr><td class=docs>
<p>Remove old file</p>
</td><td class=code><div class=highlight><pre>
    sudo rm -f /etc/sudoers.d/stack_sh_nova
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set True to configure stack.sh to run cleanly without Internet access.
stack.sh must have been previously run with Internet access to install
prerequisites and initialize $DEST.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">OFFLINE</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$OFFLINE</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set the destination directories for openstack projects</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">NOVA_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/nova
<span class="nv">HORIZON_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/horizon
<span class="nv">GLANCE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/glance
<span class="nv">KEYSTONE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/keystone
<span class="nv">NOVACLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-novaclient
<span class="nv">KEYSTONECLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-keystoneclient
<span class="nv">NOVNC_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/noVNC
<span class="nv">SWIFT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/swift
<span class="nv">QUANTUM_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/quantum
<span class="nv">QUANTUM_CLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-quantumclient
<span class="nv">MELANGE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/melange
<span class="nv">MELANGECLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-melangeclient

</pre></div></td></tr><tr><td class=docs>
<p>Default Quantum Plugin</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_PLUGIN</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_PLUGIN</span><span class="k">:-</span><span class="nv">openvswitch</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default Quantum Port</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_PORT</span><span class="k">:-</span><span class="nv">9696</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default Quantum Host</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Default Melange Port</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">M_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">M_PORT</span><span class="k">:-</span><span class="nv">9898</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default Melange Host</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">M_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">M_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Melange MAC Address Range</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">M_MAC_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">M_MAC_RANGE</span><span class="k">:-</span><span class="nv">FE</span><span class="p">-EE-DD-00-00-00/24</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Name of the lvm volume group to use/create for iscsi volumes</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">VOLUME_GROUP</span><span class="o">=</span><span class="k">${</span><span class="nv">VOLUME_GROUP</span><span class="k">:-</span><span class="nv">nova</span><span class="p">-volumes</span><span class="k">}</span>
<span class="nv">VOLUME_NAME_PREFIX</span><span class="o">=</span><span class="k">${</span><span class="nv">VOLUME_NAME_PREFIX</span><span class="k">:-</span><span class="nv">volume</span><span class="p">-</span><span class="k">}</span>
<span class="nv">INSTANCE_NAME_PREFIX</span><span class="o">=</span><span class="k">${</span><span class="nv">INSTANCE_NAME_PREFIX</span><span class="k">:-</span><span class="nv">instance</span><span class="p">-</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Nova hypervisor configuration.  We default to libvirt whth  <strong>kvm</strong> but will
drop back to <strong>qemu</strong> if we are unable to load the kvm module.  Stack.sh can
also install an <strong>LXC</strong> based system.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">VIRT_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">VIRT_DRIVER</span><span class="k">:-</span><span class="nv">libvirt</span><span class="k">}</span>
<span class="nv">LIBVIRT_TYPE</span><span class="o">=</span><span class="k">${</span><span class="nv">LIBVIRT_TYPE</span><span class="k">:-</span><span class="nv">kvm</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Nova supports pluggable schedulers.  <tt class="docutils literal">FilterScheduler</tt> should work in most
cases.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SCHEDULER</span><span class="o">=</span><span class="k">${</span><span class="nv">SCHEDULER</span><span class="k">:-</span><span class="nv">nova</span><span class="p">.scheduler.filter_scheduler.FilterScheduler</span><span class="k">}</span>

<span class="nv">HOST_IP_IFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">HOST_IP_IFACE</span><span class="k">:-</span><span class="nv">eth0</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Use the eth0 IP unless an explicit is set by <tt class="docutils literal">HOST_IP</tt> environment variable</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$HOST_IP&quot;</span> -o <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">==</span> <span class="s2">&quot;dhcp&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">HOST_IP</span><span class="o">=</span><span class="sb">`</span><span class="nv">LC_ALL</span><span class="o">=</span>C /sbin/ifconfig <span class="k">${</span><span class="nv">HOST_IP_IFACE</span><span class="k">}</span> | grep -m 1 <span class="s1">&#39;inet addr:&#39;</span>| cut -d: -f2 | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Could not determine host ip address.&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Either localrc specified dhcp on ${HOST_IP_IFACE} or defaulted to eth0&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Allow the use of an alternate hostname (such as localhost/127.0.0.1) for service endpoints.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_HOST</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure services to syslog instead of writing to individual log files</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SYSLOG</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$SYSLOG</span><span class="sb">`</span>
<span class="nv">SYSLOG_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">SYSLOG_HOST</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>
<span class="nv">SYSLOG_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">SYSLOG_PORT</span><span class="k">:-</span><span class="nv">516</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Service startup timeout</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_TIMEOUT</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_TIMEOUT</span><span class="k">:-</span><span class="nv">60</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Generic helper to configure passwords</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>read_password <span class="o">{</span>
    <span class="nb">set</span> +o xtrace
    <span class="nv">var</span><span class="o">=</span><span class="nv">$1</span>; <span class="nv">msg</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nv">pw</span><span class="o">=</span><span class="k">${</span><span class="p">!var</span><span class="k">}</span>

    <span class="nv">localrc</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/localrc

</pre></div></td></tr><tr><td class=docs>
<p>If the password is not defined yet, proceed to prompt user for a password.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> ! <span class="nv">$pw</span> <span class="o">]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>If there is no localrc file, create one</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$localrc</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>touch <span class="nv">$localrc</span>
        <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Presumably if we got this far it can only be that our localrc is missing
the required password.  Prompt user for a password and write to localrc.</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s1">&#39;&#39;</span>
        <span class="nb">echo</span> <span class="s1">&#39;################################################################################&#39;</span>
        <span class="nb">echo</span> <span class="nv">$msg</span>
        <span class="nb">echo</span> <span class="s1">&#39;################################################################################&#39;</span>
        <span class="nb">echo</span> <span class="s2">&quot;This value will be written to your localrc file so you don&#39;t have to enter it &quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;again.  Use only alphanumeric characters.&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;If you leave this blank, a random default value will be used.&quot;</span>
        <span class="nv">pw</span><span class="o">=</span><span class="s2">&quot; &quot;</span>
        <span class="k">while </span><span class="nb">true</span>; <span class="k">do</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;Enter a password now:&quot;</span>
            <span class="nb">read</span> -e <span class="nv">$var</span>
            <span class="nv">pw</span><span class="o">=</span><span class="k">${</span><span class="p">!var</span><span class="k">}</span>
            <span class="o">[[</span> <span class="s2">&quot;$pw&quot;</span> <span class="o">=</span> <span class="s2">&quot;`echo $pw | tr -cd [:alnum:]`&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>
<span class="nb">            echo</span> <span class="s2">&quot;Invalid chars in password.  Try again:&quot;</span>
        <span class="k">done</span>
<span class="k">        if</span> <span class="o">[</span> ! <span class="nv">$pw</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">pw</span><span class="o">=</span><span class="sb">`</span>openssl rand -hex 10<span class="sb">`</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nb">eval</span> <span class="s2">&quot;$var=$pw&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;$var=$pw&quot;</span> &gt;&gt; <span class="nv">$localrc</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">set</span> -o xtrace
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>This function will check if the service(s) specified in argument is
enabled by the user in ENABLED_SERVICES.</p>
<p>If there is multiple services specified as argument it will act as a
boolean OR or if any of the services specified on the command line
return true.</p>
<dl class="docutils">
<dt>There is a special cases for some 'catch-all' services :</dt>
<dd><blockquote class="first">
<blockquote>
nova would catch if any service enabled start by n-</blockquote>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 228)</p>
Block quote ends without a blank line; unexpected unindent.</div>
<p>glance would catch if any service enabled start by g-</p>
</blockquote>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 229)</p>
Block quote ends without a blank line; unexpected unindent.</div>
<p class="last">quantum would catch if any service enabled start by q-</p>
</dd>
</dl>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_service_enabled<span class="o">()</span> <span class="o">{</span>
    <span class="nv">services</span><span class="o">=</span><span class="nv">$@</span>
    <span class="k">for </span>service in <span class="k">${</span><span class="nv">services</span><span class="k">}</span>; <span class="k">do</span>
        <span class="o">[[</span> ,<span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span>, <span class="o">=</span>~ ,<span class="k">${</span><span class="nv">service</span><span class="k">}</span>, <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;nova&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;n-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;glance&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;g-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;quantum&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;q-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0
    <span class="k">done</span>
<span class="k">    return </span>1
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<div class="section" id="nova-network-configuration">
<h2>Nova Network Configuration</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>FIXME: more documentation about why these are important flags.  Also
we should make sure we use the same variable names as the flag names.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">PUBLIC_INTERFACE_DEFAULT</span><span class="o">=</span>eth3
</pre></div></td></tr><tr><td class=docs>
<p>allow build_domU.sh to specify the flat network bridge via kernel args</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="o">=</span><span class="k">$(</span>grep -o <span class="s1">&#39;flat_network_bridge=[^.]*&#39;</span> /proc/cmdline | cut -d<span class="o">=</span> -f 2<span class="k">)</span>
    <span class="nv">GUEST_INTERFACE_DEFAULT</span><span class="o">=</span>eth1
<span class="k">else</span>
<span class="k">    </span><span class="nv">PUBLIC_INTERFACE_DEFAULT</span><span class="o">=</span>br100
    <span class="nv">FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="o">=</span>br100
    <span class="nv">GUEST_INTERFACE_DEFAULT</span><span class="o">=</span>eth0
<span class="k">fi</span>

<span class="nv">PUBLIC_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">PUBLIC_INTERFACE</span><span class="k">:-</span><span class="nv">$PUBLIC_INTERFACE_DEFAULT</span><span class="k">}</span>
<span class="nv">PUBLIC_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">PUBLIC_INTERFACE</span><span class="k">:-</span><span class="nv">br100</span><span class="k">}</span>
<span class="nv">FIXED_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FIXED_RANGE</span><span class="k">:-</span><span class="nv">10</span><span class="p">.0.0.0/24</span><span class="k">}</span>
<span class="nv">FIXED_NETWORK_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">FIXED_NETWORK_SIZE</span><span class="k">:-</span><span class="nv">256</span><span class="k">}</span>
<span class="nv">FLOATING_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLOATING_RANGE</span><span class="k">:-</span><span class="nv">172</span><span class="p">.24.4.224/28</span><span class="k">}</span>
<span class="nv">NET_MAN</span><span class="o">=</span><span class="k">${</span><span class="nv">NET_MAN</span><span class="k">:-</span><span class="nv">FlatDHCPManager</span><span class="k">}</span>
<span class="nv">EC2_DMZ_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">EC2_DMZ_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
<span class="nv">FLAT_NETWORK_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_NETWORK_BRIDGE</span><span class="k">:-</span><span class="nv">$FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="k">}</span>
<span class="nv">VLAN_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">VLAN_INTERFACE</span><span class="k">:-</span><span class="nv">$GUEST_INTERFACE_DEFAULT</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Test floating pool and range are used for testing.  They are defined
here until the admin APIs can replace nova-manage</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TEST_FLOATING_POOL</span><span class="o">=</span><span class="k">${</span><span class="nv">TEST_FLOATING_POOL</span><span class="k">:-</span><span class="nv">test</span><span class="k">}</span>
<span class="nv">TEST_FLOATING_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">TEST_FLOATING_RANGE</span><span class="k">:-</span><span class="nv">192</span><span class="p">.168.253.0/29</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Multi-host is a mode where each compute node runs its own network node.  This
allows network operations and routing for a VM to occur on the server that is
running the VM - removing a SPOF and bandwidth bottleneck.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">MULTI_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">MULTI_HOST</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>If you are using FlatDHCP on multiple hosts, set the <tt class="docutils literal">FLAT_INTERFACE</tt>
variable but make sure that the interface doesn't already have an
ip or you risk breaking things.</p>
<p><strong>DHCP Warning</strong>:  If your flat interface device uses DHCP, there will be a
hiccup while the network is moved from the flat interface to the flat network
bridge.  This will happen when you launch your first instance.  Upon launch
you will lose all connectivity to the node, and the vm launch will probably
fail.</p>
<p>If you are running on a single node and don't need to access the VMs from
devices other than that node, you can set the flat interface to the same
value as <tt class="docutils literal">FLAT_NETWORK_BRIDGE</tt>.  This will stop the network hiccup from
occurring.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">FLAT_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_INTERFACE</span><span class="k">:-</span><span class="nv">$GUEST_INTERFACE_DEFAULT</span><span class="k">}</span>

<span class="c">## FIXME(ja): should/can we check that FLAT_INTERFACE is sane?</span>

</pre></div></td></tr><tr><td class=docs>
<p>Using Quantum networking:</p>
<p>Make sure that quantum is enabled in ENABLED_SERVICES.  If it is the network
manager will be set to the QuantumManager.  If you want to run Quantum on
this host, make sure that q-svc is also in ENABLED_SERVICES.</p>
<p>If you're planning to use the Quantum openvswitch plugin, set Q_PLUGIN to
&quot;openvswitch&quot; and make sure the q-agt service is enabled in
ENABLED_SERVICES.</p>
<p>With Quantum networking the NET_MAN variable is ignored.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Using Melange IPAM:</p>
<p>Make sure that quantum and melange are enabled in ENABLED_SERVICES.
If they are then the melange IPAM lib will be set in the QuantumManager.
Adding m-svc to ENABLED_SERVICES will start the melange service on this
host.</p>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="mysql-rabbitmq">
<h2>MySQL &amp; RabbitMQ</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>We configure Nova, Horizon, Glance and Keystone to use MySQL as their
database server.  While they share a single server, each has their own
database and tables.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>By default this script will install and configure MySQL.  If you want to
use an existing server, you can pass in the user/password/host parameters.
You will need to send the same <tt class="docutils literal">MYSQL_PASSWORD</tt> to every host if you are doing
a multi-node devstack installation.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">MYSQL_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">MYSQL_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>
<span class="nv">MYSQL_USER</span><span class="o">=</span><span class="k">${</span><span class="nv">MYSQL_USER</span><span class="k">:-</span><span class="nv">root</span><span class="k">}</span>
read_password MYSQL_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR MYSQL.&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>don't specify /db in this string, so we can use it for multiple services</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">BASE_SQL_CONN</span><span class="o">=</span><span class="k">${</span><span class="nv">BASE_SQL_CONN</span><span class="k">:-</span><span class="nv">mysql</span><span class="p">://</span><span class="nv">$MYSQL_USER</span><span class="p">:</span><span class="nv">$MYSQL_PASSWORD</span><span class="p">@</span><span class="nv">$MYSQL_HOST</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Rabbit connection info</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">RABBIT_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">RABBIT_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>
read_password RABBIT_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR RABBIT.&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Glance connection info.  Note the port must be specified.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">GLANCE_HOSTPORT</span><span class="o">=</span><span class="k">${</span><span class="nv">GLANCE_HOSTPORT</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="p">:</span><span class="nv">9292</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="swift">
<h2>SWIFT</h2>
<p>TODO: implement glance support
TODO: add logging to different location.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>By default the location of swift drives and objects is located inside
the swift source directory. SWIFT_DATA_LOCATION variable allow you to redefine
this.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_DATA_LOCATION</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">:-${</span><span class="nv">SWIFT_DIR</span><span class="k">}</span><span class="p">/data</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>We are going to have the configuration files inside the source
directory, change SWIFT_CONFIG_LOCATION if you want to adjust that.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_CONFIG_LOCATION</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">:-${</span><span class="nv">SWIFT_DIR</span><span class="k">}</span><span class="p">/config</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>devstack will create a loop-back disk formatted as XFS to store the
swift data. By default the disk size is 1 gigabyte. The variable
SWIFT_LOOPBACK_DISK_SIZE specified in bytes allow you to change
that.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_LOOPBACK_DISK_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_LOOPBACK_DISK_SIZE</span><span class="k">:-</span><span class="nv">1000000</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>The ring uses a configurable number of bits from a pathâ€™s MD5 hash as
a partition index that designates a device. The number of bits kept
from the hash is known as the partition power, and 2 to the partition
power indicates the partition count. Partitioning the full MD5 hash
ring allows other parts of the cluster to work in batches of items at
once which ends up either more efficient or at least less complex than
working with each item separately or the entire cluster all at once.
By default we define 9 for the partition count (which mean 512).</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">:-</span><span class="nv">9</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>This variable allows you to configure how many replicas you want to be
configured for your Swift cluster.  By default the three replicas would need a
bit of IO and Memory on a VM you may want to lower that to 1 if you want to do
only some quick testing.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_REPLICAS</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">:-</span><span class="nv">3</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>We only ask for Swift Hash if we have enabled swift service.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>SWIFT_HASH is a random unique string for a swift cluster that
can never change.</p>
</td><td class=code><div class=highlight><pre>
    read_password SWIFT_HASH <span class="s2">&quot;ENTER A RANDOM SWIFT HASH.&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="keystone">
<h2>Keystone</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Service Token - Openstack components need to have an admin token
to validate user tokens.</p>
</td><td class=code><div class=highlight><pre>
read_password SERVICE_TOKEN <span class="s2">&quot;ENTER A SERVICE_TOKEN TO USE FOR THE SERVICE ADMIN TOKEN.&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Services authenticate to Identity with servicename/SERVICE_PASSWORD</p>
</td><td class=code><div class=highlight><pre>
read_password SERVICE_PASSWORD <span class="s2">&quot;ENTER A SERVICE_PASSWORD TO USE FOR THE SERVICE AUTHENTICATION.&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Horizon currently truncates usernames and passwords at 20 characters</p>
</td><td class=code><div class=highlight><pre>
read_password ADMIN_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR HORIZON AND KEYSTONE (20 CHARS OR LESS).&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set the tenant for service accounts in Keystone</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_TENANT_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_TENANT_NAME</span><span class="k">:-</span><span class="nv">service</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set Keystone interface configuration</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">KEYSTONE_API_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_API_PORT</span><span class="k">:-</span><span class="nv">5000</span><span class="k">}</span>
<span class="nv">KEYSTONE_AUTH_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_AUTH_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
<span class="nv">KEYSTONE_AUTH_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_AUTH_PORT</span><span class="k">:-</span><span class="nv">35357</span><span class="k">}</span>
<span class="nv">KEYSTONE_AUTH_PROTOCOL</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_AUTH_PROTOCOL</span><span class="k">:-</span><span class="nv">http</span><span class="k">}</span>
<span class="nv">KEYSTONE_SERVICE_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_SERVICE_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
<span class="nv">KEYSTONE_SERVICE_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_SERVICE_PORT</span><span class="k">:-</span><span class="nv">5000</span><span class="k">}</span>
<span class="nv">KEYSTONE_SERVICE_PROTOCOL</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_SERVICE_PROTOCOL</span><span class="k">:-</span><span class="nv">http</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="horizon">
<h2>Horizon</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Allow overriding the default Apache user and group, default both to
current user.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">APACHE_USER</span><span class="o">=</span><span class="k">${</span><span class="nv">APACHE_USER</span><span class="k">:-</span><span class="nv">$USER</span><span class="k">}</span>
<span class="nv">APACHE_GROUP</span><span class="o">=</span><span class="k">${</span><span class="nv">APACHE_GROUP</span><span class="k">:-</span><span class="nv">$APACHE_USER</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="log-files">
<h2>Log files</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Set up logging for stack.sh
Set LOGFILE to turn on logging
We append '.xxxxxxxx' to the given name to maintain history
where xxxxxxxx is a representation of the date the file was created</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">||</span> -n <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">LOGDAYS</span><span class="o">=</span><span class="k">${</span><span class="nv">LOGDAYS</span><span class="k">:-</span><span class="nv">7</span><span class="k">}</span>
    <span class="nv">TIMESTAMP_FORMAT</span><span class="o">=</span><span class="k">${</span><span class="nv">TIMESTAMP_FORMAT</span><span class="k">:-</span><span class="s2">&quot;%F-%H%M%S&quot;</span><span class="k">}</span>
    <span class="nv">CURRENT_LOG_TIME</span><span class="o">=</span><span class="k">$(</span>date <span class="s2">&quot;+$TIMESTAMP_FORMAT&quot;</span><span class="k">)</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>First clean up old log files.  Use the user-specified LOGFILE
as the template to search for, appending '.*' to match the date
we added on earlier runs.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">LOGDIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">&quot;$LOGFILE&quot;</span><span class="k">)</span>
    <span class="nv">LOGNAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$LOGFILE&quot;</span><span class="k">)</span>
    mkdir -p <span class="nv">$LOGDIR</span>
    find <span class="nv">$LOGDIR</span> -maxdepth 1 -name <span class="nv">$LOGNAME</span>.<span class="se">\*</span> -mtime +<span class="nv">$LOGDAYS</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>

    <span class="nv">LOGFILE</span><span class="o">=</span><span class="nv">$LOGFILE</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Redirect stdout/stderr to tee to write the log file</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>1&gt; &gt;<span class="o">(</span> tee <span class="s2">&quot;${LOGFILE}&quot;</span> <span class="o">)</span> 2&gt;&amp;1
    <span class="nb">echo</span> <span class="s2">&quot;stack.sh log $LOGFILE&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Specified logfile name always links to the most recent log</p>
</td><td class=code><div class=highlight><pre>
    ln -sf <span class="nv">$LOGFILE</span> <span class="nv">$LOGDIR</span>/<span class="nv">$LOGNAME</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up logging of screen windows
Set SCREEN_LOGDIR to turn on logging of screen windows to the
directory specified in SCREEN_LOGDIR, we will log to the the file
screen-$SERVICE_NAME-$TIMESTAMP.log in that dir and have a link
screen-$SERVICE_NAME.log to the latest log file.
Logs are kept for as long specified in LOGDAYS.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>

</pre></div></td></tr><tr><td class=docs>
<p>We make sure the directory is created.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -d <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>We cleanup the old logs</p>
</td><td class=code><div class=highlight><pre>
        find <span class="nv">$SCREEN_LOGDIR</span> -maxdepth 1 -name screen-<span class="se">\*</span>.log -mtime +<span class="nv">$LOGDAYS</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>
    <span class="k">else</span>
<span class="k">        </span>mkdir -p <span class="nv">$SCREEN_LOGDIR</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>So that errors don't compound we exit on any errors so you see only the
first error that occurred.</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">trap </span>failed ERR
failed<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">r</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">set</span> +o xtrace
    <span class="o">[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;${0##*/} failed: full log in $LOGFILE&quot;</span>
    <span class="nb">exit</span> <span class="nv">$r</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Print the commands being run so that we can see the command that triggers
an error.  It is also useful for following along as the install occurs.</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -o xtrace

</pre></div></td></tr><tr><td class=docs>
<p>create the destination directory and ensure it is writable by the user</p>
</td><td class=code><div class=highlight><pre>
sudo mkdir -p <span class="nv">$DEST</span>
<span class="k">if</span> <span class="o">[</span> ! -w <span class="nv">$DEST</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$DEST</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="install-packages">
<h1>Install Packages</h1>
<p>Openstack uses a fair number of other projects.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<ul class="simple">
<li>We are going to install packages only for the services needed.</li>
<li>We are parsing the packages files and detecting metadatas.</li>
</ul>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 482)</p>
Bullet list ends without a blank line; unexpected unindent.</div>
<blockquote>
<ul class="simple">
<li>If there is a NOPRIME as comment mean we are not doing the install
just yet.</li>
<li>If we have the meta-keyword dist:DISTRO or
dist:DISTRO1,DISTRO2 it will be installed only for those
distros (case insensitive).</li>
</ul>
</blockquote>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_packages<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">package_dir</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span>file_to_parse
    <span class="nb">local </span>service

    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$package_dir&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;No package directory supplied&quot;</span>
        <span class="k">return </span>1
    <span class="k">fi</span>
<span class="k">    for </span>service in general <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>        <span class="c"># Allow individual services to specify dependencies</span>
        <span class="k">if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">package_dir</span><span class="k">}</span>/<span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} $service&quot;</span>
        <span class="k">fi</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> n-* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ nova <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} nova&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> g-* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ glance <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} glance&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> key* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ keystone <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} keystone&quot;</span>
            <span class="k">fi</span>
<span class="k">        fi</span>
<span class="k">    done</span>

<span class="k">    for </span>file in <span class="k">${</span><span class="nv">file_to_parse</span><span class="k">}</span>; <span class="k">do</span>
<span class="k">        </span><span class="nb">local </span><span class="nv">fname</span><span class="o">=</span><span class="k">${</span><span class="nv">package_dir</span><span class="k">}</span>/<span class="k">${</span><span class="nv">file</span><span class="k">}</span>
        <span class="nb">local </span>OIFS line package distros distro
        <span class="o">[[</span> -e <span class="nv">$fname</span> <span class="o">]]</span> <span class="o">||</span> <span class="k">continue</span>

<span class="k">        </span><span class="nv">OIFS</span><span class="o">=</span><span class="nv">$IFS</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
        <span class="k">for </span>line in <span class="k">$(</span>&lt;<span class="k">${</span><span class="nv">fname</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            if</span> <span class="o">[[</span> <span class="nv">$line</span> <span class="o">=</span>~ <span class="s2">&quot;NOPRIME&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                continue</span>
<span class="k">            fi</span>

<span class="k">            if</span> <span class="o">[[</span> <span class="nv">$line</span> <span class="o">=</span>~ <span class="o">(</span>.*<span class="o">)</span><span class="c">#.*dist:([^ ]*) ]]; then # We are using BASH regexp matching feature.</span>
                        <span class="nv">package</span><span class="o">=</span><span class="k">${</span><span class="nv">BASH_REMATCH</span><span class="p">[1]</span><span class="k">}</span>
                        <span class="nv">distros</span><span class="o">=</span><span class="k">${</span><span class="nv">BASH_REMATCH</span><span class="p">[2]</span><span class="k">}</span>
                        <span class="k">for </span>distro in <span class="k">${</span><span class="nv">distros</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>  <span class="c">#In bash ${VAR,,} will lowecase VAR</span>
                            <span class="o">[[</span> <span class="k">${</span><span class="nv">distro</span><span class="p">,,</span><span class="k">}</span> <span class="o">==</span> <span class="k">${</span><span class="nv">DISTRO</span><span class="p">,,</span><span class="k">}</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nv">$package</span>
                        <span class="k">done</span>
<span class="k">                        continue</span>
<span class="k">            fi</span>

<span class="k">            </span><span class="nb">echo</span> <span class="k">${</span><span class="nv">line</span><span class="p">%#*</span><span class="k">}</span>
        <span class="k">done</span>
<span class="k">        </span><span class="nv">IFS</span><span class="o">=</span><span class="nv">$OIFS</span>
    <span class="k">done</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>install apt requirements</p>
</td><td class=code><div class=highlight><pre>
apt_get update
apt_get install <span class="k">$(</span>get_packages <span class="nv">$FILES</span>/apts<span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>install python requirements</p>
</td><td class=code><div class=highlight><pre>
pip_install <span class="k">$(</span>get_packages <span class="nv">$FILES</span>/pips | sort -u<span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>compute service</p>
</td><td class=code><div class=highlight><pre>
git_clone <span class="nv">$NOVA_REPO</span> <span class="nv">$NOVA_DIR</span> <span class="nv">$NOVA_BRANCH</span>
</pre></div></td></tr><tr><td class=docs>
<p>python client library to nova that horizon (and others) use</p>
</td><td class=code><div class=highlight><pre>
git_clone <span class="nv">$KEYSTONECLIENT_REPO</span> <span class="nv">$KEYSTONECLIENT_DIR</span> <span class="nv">$KEYSTONECLIENT_BRANCH</span>
git_clone <span class="nv">$NOVACLIENT_REPO</span> <span class="nv">$NOVACLIENT_DIR</span> <span class="nv">$NOVACLIENT_BRANCH</span>

</pre></div></td></tr><tr><td class=docs>
<p>glance, swift middleware and nova api needs keystone middleware</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key g-api n-api swift; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>unified auth system (manages accounts/tokens)</p>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$KEYSTONE_REPO</span> <span class="nv">$KEYSTONE_DIR</span> <span class="nv">$KEYSTONE_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>storage service</p>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$SWIFT_REPO</span> <span class="nv">$SWIFT_DIR</span> <span class="nv">$SWIFT_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled g-api n-api; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>image catalog service</p>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$GLANCE_REPO</span> <span class="nv">$GLANCE_DIR</span> <span class="nv">$GLANCE_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled n-novnc; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>a websockets/html5 or flash powered VNC console for vm instances</p>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$NOVNC_REPO</span> <span class="nv">$NOVNC_DIR</span> <span class="nv">$NOVNC_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>django powered web control panel for openstack</p>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$HORIZON_REPO</span> <span class="nv">$HORIZON_DIR</span> <span class="nv">$HORIZON_BRANCH</span> <span class="nv">$HORIZON_TAG</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled q-svc; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>quantum</p>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$QUANTUM_REPO</span> <span class="nv">$QUANTUM_DIR</span> <span class="nv">$QUANTUM_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled q-svc horizon; <span class="k">then</span>
<span class="k">    </span>git_clone <span class="nv">$QUANTUM_CLIENT_REPO</span> <span class="nv">$QUANTUM_CLIENT_DIR</span> <span class="nv">$QUANTUM_CLIENT_BRANCH</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled m-svc; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>melange</p>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$MELANGE_REPO</span> <span class="nv">$MELANGE_DIR</span> <span class="nv">$MELANGE_BRANCH</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled melange; <span class="k">then</span>
<span class="k">    </span>git_clone <span class="nv">$MELANGECLIENT_REPO</span> <span class="nv">$MELANGECLIENT_DIR</span> <span class="nv">$MELANGECLIENT_BRANCH</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="initialization">
<h1>Initialization</h1>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
<p>setup our checkouts so they are installed into python path
allowing <tt class="docutils literal">import nova</tt> or <tt class="docutils literal">import glance.client</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="nb">cd</span> <span class="nv">$KEYSTONECLIENT_DIR</span>; sudo python setup.py develop
<span class="nb">cd</span> <span class="nv">$NOVACLIENT_DIR</span>; sudo python setup.py develop
<span class="k">if </span>is_service_enabled key g-api n-api swift; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$KEYSTONE_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$SWIFT_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled g-api n-api; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$GLANCE_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>
<span class="nb">cd</span> <span class="nv">$NOVA_DIR</span>; sudo python setup.py develop
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$HORIZON_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled q-svc; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$QUANTUM_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled q-svc horizon; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$QUANTUM_CLIENT_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled m-svc; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$MELANGE_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled melange; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$MELANGECLIENT_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<div class="section" id="syslog">
<h2>Syslog</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$SYSLOG</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>apt_get install -y rsyslog-relp
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$SYSLOG_HOST&quot;</span> <span class="o">=</span> <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Configure the master host to receive</p>
</td><td class=code><div class=highlight><pre>
        cat <span class="s">&lt;&lt;EOF &gt;/tmp/90-stack-m.conf</span>
<span class="s">\$ModLoad imrelp</span>
<span class="s">\$InputRELPServerRun $SYSLOG_PORT</span>
<span class="s">EOF</span>
        sudo mv /tmp/90-stack-m.conf /etc/rsyslog.d
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set rsyslog to send to remote host</p>
</td><td class=code><div class=highlight><pre>
        cat <span class="s">&lt;&lt;EOF &gt;/tmp/90-stack-s.conf</span>
<span class="s">*.*		:omrelp:$SYSLOG_HOST:$SYSLOG_PORT</span>
<span class="s">EOF</span>
        sudo mv /tmp/90-stack-s.conf /etc/rsyslog.d
    <span class="k">fi</span>
<span class="k">    </span>sudo /usr/sbin/service rsyslog restart
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="rabbit">
<h2>Rabbit</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled rabbit; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Install and start rabbitmq-server
the temp file is necessary due to LP: #878600</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">tfile</span><span class="o">=</span><span class="k">$(</span>mktemp<span class="k">)</span>
    apt_get install rabbitmq-server &gt; <span class="s2">&quot;$tfile&quot;</span> 2&gt;&amp;1
    cat <span class="s2">&quot;$tfile&quot;</span>
    rm -f <span class="s2">&quot;$tfile&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>change the rabbit password since the default is &quot;guest&quot;</p>
</td><td class=code><div class=highlight><pre>
    sudo rabbitmqctl change_password guest <span class="nv">$RABBIT_PASSWORD</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="mysql">
<h2>Mysql</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled mysql; <span class="k">then</span>

</pre></div></td></tr><tr><td class=docs>
<p>Seed configuration with mysql password so that apt-get install doesn't
prompt us for a password upon install.</p>
</td><td class=code><div class=highlight><pre>
    cat <span class="s">&lt;&lt;MYSQL_PRESEED | sudo debconf-set-selections</span>
<span class="s">mysql-server-5.1 mysql-server/root_password password $MYSQL_PASSWORD</span>
<span class="s">mysql-server-5.1 mysql-server/root_password_again password $MYSQL_PASSWORD</span>
<span class="s">mysql-server-5.1 mysql-server/start_on_boot boolean true</span>
<span class="s">MYSQL_PRESEED</span>

</pre></div></td></tr><tr><td class=docs>
<p>while <tt class="docutils literal">.my.cnf</tt> is not needed for openstack to function, it is useful
as it allows you to access the mysql databases via <tt class="docutils literal">mysql nova</tt> instead
of having to specify the username/password each time.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> ! -e <span class="nv">$HOME</span>/.my.cnf <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>cat <span class="s">&lt;&lt;EOF &gt;$HOME/.my.cnf</span>
<span class="s">[client]</span>
<span class="s">user=$MYSQL_USER</span>
<span class="s">password=$MYSQL_PASSWORD</span>
<span class="s">host=$MYSQL_HOST</span>
<span class="s">EOF</span>
        chmod 0600 <span class="nv">$HOME</span>/.my.cnf
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install and start mysql-server</p>
</td><td class=code><div class=highlight><pre>
    apt_get install mysql-server
</pre></div></td></tr><tr><td class=docs>
<p>Update the DB to give user â€˜$MYSQL_USERâ€™&#64;â€™%â€™ full control of the all databases:</p>
</td><td class=code><div class=highlight><pre>
    sudo mysql -uroot -p<span class="nv">$MYSQL_PASSWORD</span> -h127.0.0.1 -e <span class="s2">&quot;GRANT ALL PRIVILEGES ON *.* TO &#39;$MYSQL_USER&#39;@&#39;%&#39; identified by &#39;$MYSQL_PASSWORD&#39;;&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Edit /etc/mysql/my.cnf to change â€˜bind-addressâ€™ from localhost (127.0.0.1) to any (0.0.0.0) and restart the mysql service:</p>
</td><td class=code><div class=highlight><pre>
    sudo sed -i <span class="s1">&#39;s/127.0.0.1/0.0.0.0/g&#39;</span> /etc/mysql/my.cnf
    sudo service mysql restart
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="id1">
<h2>Horizon</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Setup the django horizon application to serve via apache/wsgi</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install apache2, which is NOPRIME'd</p>
</td><td class=code><div class=highlight><pre>
    apt_get install apache2 libapache2-mod-wsgi

</pre></div></td></tr><tr><td class=docs>
<p>Link to quantum client directory.</p>
</td><td class=code><div class=highlight><pre>
    rm -fr <span class="k">${</span><span class="nv">HORIZON_DIR</span><span class="k">}</span>/openstack_dashboard/quantum
    ln -s <span class="k">${</span><span class="nv">QUANTUM_CLIENT_DIR</span><span class="k">}</span>/quantum <span class="k">${</span><span class="nv">HORIZON_DIR</span><span class="k">}</span>/openstack_dashboard/quantum

</pre></div></td></tr><tr><td class=docs>
<p>Remove stale session database.</p>
</td><td class=code><div class=highlight><pre>
    rm -f <span class="nv">$HORIZON_DIR</span>/openstack_dashboard/local/dashboard_openstack.sqlite3

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">local_settings.py</tt> is used to override horizon default settings.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">local_settings</span><span class="o">=</span><span class="nv">$HORIZON_DIR</span>/openstack_dashboard/local/local_settings.py
    cp <span class="nv">$FILES</span>/horizon_settings.py <span class="nv">$local_settings</span>

</pre></div></td></tr><tr><td class=docs>
<p>Enable quantum in dashboard, if requested</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">        </span>sudo sed -e <span class="s2">&quot;s,QUANTUM_ENABLED = False,QUANTUM_ENABLED = True,g&quot;</span> -i <span class="nv">$local_settings</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Initialize the horizon database (it stores sessions and notices shown to
users).  The user system is external (keystone).</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">cd</span> <span class="nv">$HORIZON_DIR</span>
    python manage.py syncdb

</pre></div></td></tr><tr><td class=docs>
<p>create an empty directory that apache uses as docroot</p>
</td><td class=code><div class=highlight><pre>
    sudo mkdir -p <span class="nv">$HORIZON_DIR</span>/.blackhole

    <span class="c">## Configure apache&#39;s 000-default to run horizon</span>
    sudo cp <span class="nv">$FILES</span>/000-default.template /etc/apache2/sites-enabled/000-default
    sudo sed -e <span class="s2">&quot;</span>
<span class="s2">        s,%USER%,$APACHE_USER,g;</span>
<span class="s2">        s,%GROUP%,$APACHE_GROUP,g;</span>
<span class="s2">        s,%HORIZON_DIR%,$HORIZON_DIR,g;</span>
<span class="s2">    &quot;</span> -i /etc/apache2/sites-enabled/000-default
    sudo service apache2 restart
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="glance">
<h2>Glance</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
<span class="k">    </span><span class="nv">GLANCE_IMAGE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/glance/images
</pre></div></td></tr><tr><td class=docs>
<p>Delete existing images</p>
</td><td class=code><div class=highlight><pre>
    rm -rf <span class="nv">$GLANCE_IMAGE_DIR</span>

</pre></div></td></tr><tr><td class=docs>
<p>Use local glance directories</p>
</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$GLANCE_IMAGE_DIR</span>

</pre></div></td></tr><tr><td class=docs>
<p>(re)create glance database</p>
</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS glance;&#39;</span>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;CREATE DATABASE glance;&#39;</span>

    <span class="k">function </span>glance_config <span class="o">{</span>
        sudo sed -e <span class="s2">&quot;</span>
<span class="s2">            s,%KEYSTONE_API_PORT%,$KEYSTONE_API_PORT,g;</span>
<span class="s2">            s,%KEYSTONE_AUTH_HOST%,$KEYSTONE_AUTH_HOST,g;</span>
<span class="s2">            s,%KEYSTONE_AUTH_PORT%,$KEYSTONE_AUTH_PORT,g;</span>
<span class="s2">            s,%KEYSTONE_AUTH_PROTOCOL%,$KEYSTONE_AUTH_PROTOCOL,g;</span>
<span class="s2">            s,%KEYSTONE_SERVICE_HOST%,$KEYSTONE_SERVICE_HOST,g;</span>
<span class="s2">            s,%KEYSTONE_SERVICE_PORT%,$KEYSTONE_SERVICE_PORT,g;</span>
<span class="s2">            s,%KEYSTONE_SERVICE_PROTOCOL%,$KEYSTONE_SERVICE_PROTOCOL,g;</span>
<span class="s2">            s,%SQL_CONN%,$BASE_SQL_CONN/glance,g;</span>
<span class="s2">            s,%SERVICE_TENANT_NAME%,$SERVICE_TENANT_NAME,g;</span>
<span class="s2">            s,%SERVICE_USERNAME%,glance,g;</span>
<span class="s2">            s,%SERVICE_PASSWORD%,$SERVICE_PASSWORD,g;</span>
<span class="s2">            s,%SERVICE_TOKEN%,$SERVICE_TOKEN,g;</span>
<span class="s2">            s,%DEST%,$DEST,g;</span>
<span class="s2">            s,%SYSLOG%,$SYSLOG,g;</span>
<span class="s2">        &quot;</span> -i <span class="nv">$1</span>
    <span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Copy over our glance configurations and update them</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">GLANCE_REGISTRY_CONF</span><span class="o">=</span><span class="nv">$GLANCE_DIR</span>/etc/glance-registry.conf
    cp <span class="nv">$FILES</span>/glance-registry.conf <span class="nv">$GLANCE_REGISTRY_CONF</span>
    glance_config <span class="nv">$GLANCE_REGISTRY_CONF</span>

    <span class="k">if</span> <span class="o">[[</span> -e <span class="nv">$FILES</span>/glance-registry-paste.ini <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">GLANCE_REGISTRY_PASTE_INI</span><span class="o">=</span><span class="nv">$GLANCE_DIR</span>/etc/glance-registry-paste.ini
        cp <span class="nv">$FILES</span>/glance-registry-paste.ini <span class="nv">$GLANCE_REGISTRY_PASTE_INI</span>
        glance_config <span class="nv">$GLANCE_REGISTRY_PASTE_INI</span>
    <span class="k">fi</span>

<span class="k">    </span><span class="nv">GLANCE_API_CONF</span><span class="o">=</span><span class="nv">$GLANCE_DIR</span>/etc/glance-api.conf
    cp <span class="nv">$FILES</span>/glance-api.conf <span class="nv">$GLANCE_API_CONF</span>
    glance_config <span class="nv">$GLANCE_API_CONF</span>

    <span class="k">if</span> <span class="o">[[</span> -e <span class="nv">$FILES</span>/glance-api-paste.ini <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">GLANCE_API_PASTE_INI</span><span class="o">=</span><span class="nv">$GLANCE_DIR</span>/etc/glance-api-paste.ini
        cp <span class="nv">$FILES</span>/glance-api-paste.ini <span class="nv">$GLANCE_API_PASTE_INI</span>
        glance_config <span class="nv">$GLANCE_API_PASTE_INI</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="nova">
<h2>Nova</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Put config files in /etc/nova for everyone to find</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">NOVA_CONF_DIR</span><span class="o">=</span>/etc/nova
<span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$NOVA_CONF_DIR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>sudo mkdir -p <span class="nv">$NOVA_CONF_DIR</span>
<span class="k">fi</span>
sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$NOVA_CONF_DIR</span>

<span class="k">if </span>is_service_enabled n-api; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>We are going to use a sample http middleware configuration based on the
one from the keystone project to launch nova.  This paste config adds
the configuration required for nova to validate keystone tokens.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Remove legacy paste config</p>
</td><td class=code><div class=highlight><pre>
    rm -f <span class="nv">$NOVA_DIR</span>/bin/nova-api-paste.ini

</pre></div></td></tr><tr><td class=docs>
<p>First we add a some extra data to the default paste config from nova</p>
</td><td class=code><div class=highlight><pre>
    cp <span class="nv">$NOVA_DIR</span>/etc/nova/api-paste.ini <span class="nv">$NOVA_CONF_DIR</span>

</pre></div></td></tr><tr><td class=docs>
<p>Then we add our own service token to the configuration</p>
</td><td class=code><div class=highlight><pre>
    sed -e <span class="s2">&quot;</span>
<span class="s2">        /^admin_token/i admin_tenant_name = $SERVICE_TENANT_NAME</span>
<span class="s2">        /admin_tenant_name/s/^.*$/admin_tenant_name = $SERVICE_TENANT_NAME/;</span>
<span class="s2">        /admin_user/s/^.*$/admin_user = nova/;</span>
<span class="s2">        /admin_password/s/^.*$/admin_password = $SERVICE_PASSWORD/;</span>
<span class="s2">        s,%SERVICE_TENANT_NAME%,$SERVICE_TENANT_NAME,g;</span>
<span class="s2">        s,%SERVICE_TOKEN%,$SERVICE_TOKEN,g;</span>
<span class="s2">    &quot;</span> -i <span class="nv">$NOVA_CONF_DIR</span>/api-paste.ini

</pre></div></td></tr><tr><td class=docs>
<p>Finally, we change the pipelines in nova to use keystone</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">function </span>replace_pipeline<span class="o">()</span> <span class="o">{</span>
        sed <span class="s2">&quot;/\[pipeline:$1\]/,/\[/s/^pipeline = .*/pipeline = $2/&quot;</span> -i <span class="nv">$NOVA_CONF_DIR</span>/api-paste.ini
    <span class="o">}</span>
    replace_pipeline <span class="s2">&quot;ec2cloud&quot;</span> <span class="s2">&quot;ec2faultwrap logrequest totoken authtoken keystonecontext cloudrequest authorizer validator ec2executor&quot;</span>
    replace_pipeline <span class="s2">&quot;ec2admin&quot;</span> <span class="s2">&quot;ec2faultwrap logrequest totoken authtoken keystonecontext adminrequest authorizer ec2executor&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>allow people to turn off rate limiting for testing, like when using tempest, by setting OSAPI_RATE_LIMIT=&quot; &quot;</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">OSAPI_RATE_LIMIT</span><span class="o">=</span><span class="k">${</span><span class="nv">OSAPI_RATE_LIMIT</span><span class="k">:-</span><span class="s2">&quot;ratelimit&quot;</span><span class="k">}</span>
    replace_pipeline <span class="s2">&quot;openstack_compute_api_v2&quot;</span> <span class="s2">&quot;faultwrap authtoken keystonecontext $OSAPI_RATE_LIMIT osapi_compute_app_v2&quot;</span>
    replace_pipeline <span class="s2">&quot;openstack_volume_api_v1&quot;</span> <span class="s2">&quot;faultwrap authtoken keystonecontext $OSAPI_RATE_LIMIT osapi_volume_app_v1&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Helper to clean iptables rules</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>clean_iptables<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Delete rules</p>
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> | grep <span class="s2">&quot;\-A&quot;</span> |  sed <span class="s2">&quot;s/-A/-D/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables&quot;,$0}&#39;</span> | bash
</pre></div></td></tr><tr><td class=docs>
<p>Delete nat rules</p>
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v -t nat | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> |  grep <span class="s2">&quot;\-A&quot;</span> | sed <span class="s2">&quot;s/-A/-D/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables -t nat&quot;,$0}&#39;</span> | bash
</pre></div></td></tr><tr><td class=docs>
<p>Delete chains</p>
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> | grep <span class="s2">&quot;\-N&quot;</span> |  sed <span class="s2">&quot;s/-N/-X/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables&quot;,$0}&#39;</span> | bash
</pre></div></td></tr><tr><td class=docs>
<p>Delete nat chains</p>
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v -t nat | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> |  grep <span class="s2">&quot;\-N&quot;</span> | sed <span class="s2">&quot;s/-N/-X/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables -t nat&quot;,$0}&#39;</span> | bash
<span class="o">}</span>

<span class="k">if </span>is_service_enabled n-cpu; <span class="k">then</span>

</pre></div></td></tr><tr><td class=docs>
<div class="section" id="virtualization-configuration">
<h3>Virtualization Configuration</h3>
</td><td class=code><div class=highlight><pre>
    apt_get install libvirt-bin

</pre></div></td></tr><tr><td class=docs>
<p>Force IP forwarding on, just on case</p>
</td><td class=code><div class=highlight><pre>
    sudo sysctl -w net.ipv4.ip_forward<span class="o">=</span>1

</pre></div></td></tr><tr><td class=docs>
<p>attempt to load modules: network block device - used to manage qcow images</p>
</td><td class=code><div class=highlight><pre>
    sudo modprobe nbd <span class="o">||</span> <span class="nb">true</span>

</pre></div></td></tr><tr><td class=docs>
<p>Check for kvm (hardware based virtualization).  If unable to initialize
kvm, we drop back to the slower emulation mode (qemu).  Note: many systems
come with hardware virtualization disabled in BIOS.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;kvm&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo modprobe kvm <span class="o">||</span> <span class="nb">true</span>
<span class="nb">        </span><span class="k">if</span> <span class="o">[</span> ! -e /dev/kvm <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: Switching to QEMU&quot;</span>
            <span class="nv">LIBVIRT_TYPE</span><span class="o">=</span>qemu
        <span class="k">fi</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install and configure <strong>LXC</strong> if specified.  LXC is another approach to
splitting a system into many smaller parts.  LXC uses cgroups and chroot
to simulate multiple systems.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;lxc&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$DISTRO&quot;</span> &gt; natty <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>apt_get install cgroup-lite
        <span class="k">else</span>
<span class="k">            </span><span class="nv">cgline</span><span class="o">=</span><span class="s2">&quot;none /cgroup cgroup cpuacct,memory,devices,cpu,freezer,blkio 0 0&quot;</span>
            sudo mkdir -p /cgroup
            <span class="k">if</span> ! grep -q cgroup /etc/fstab; <span class="k">then</span>
<span class="k">                </span><span class="nb">echo</span> <span class="s2">&quot;$cgline&quot;</span> | sudo tee -a /etc/fstab
            <span class="k">fi</span>
<span class="k">            if</span> ! mount -n | grep -q cgroup; <span class="k">then</span>
<span class="k">                </span>sudo mount /cgroup
            <span class="k">fi</span>
<span class="k">        fi</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>The user that nova runs as needs to be member of libvirtd group otherwise
nova-compute will be unable to use libvirt.</p>
</td><td class=code><div class=highlight><pre>
    sudo usermod -a -G libvirtd <span class="sb">`</span>whoami<span class="sb">`</span>
</pre></div></td></tr><tr><td class=docs>
<p>libvirt detects various settings on startup, as we potentially changed
the system configuration (modules, filesystems), we need to restart
libvirt to detect those changes.</p>
</td><td class=code><div class=highlight><pre>
    sudo /etc/init.d/libvirt-bin restart


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="instance-storage">
<h3>Instance Storage</h3>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Nova stores each instance in its own directory.</p>
</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$NOVA_DIR</span>/instances

</pre></div></td></tr><tr><td class=docs>
<p>You can specify a different disk to be mounted and used for backing the
virtual machines.  If there is a partition labeled nova-instances we
mount it (ext filesystems can be labeled via e2label).</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> -L /dev/disk/by-label/nova-instances <span class="o">]</span>; <span class="k">then</span>
<span class="k">        if</span> ! mount -n | grep -q <span class="nv">$NOVA_DIR</span>/instances; <span class="k">then</span>
<span class="k">            </span>sudo mount -L nova-instances <span class="nv">$NOVA_DIR</span>/instances
            sudo chown -R <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$NOVA_DIR</span>/instances
        <span class="k">fi</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Clean iptables from previous runs</p>
</td><td class=code><div class=highlight><pre>
    clean_iptables

</pre></div></td></tr><tr><td class=docs>
<p>Destroy old instances</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">instances</span><span class="o">=</span><span class="sb">`</span>virsh list --all | grep <span class="nv">$INSTANCE_NAME_PREFIX</span> | sed <span class="s2">&quot;s/.*\($INSTANCE_NAME_PREFIX[0-9a-fA-F]*\).*/\1/g&quot;</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[</span> ! <span class="s2">&quot;$instances&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="nv">$instances</span> | xargs -n1 virsh destroy <span class="o">||</span> <span class="nb">true</span>
<span class="nb">        echo</span> <span class="nv">$instances</span> | xargs -n1 virsh undefine <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span><span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Logout and delete iscsi sessions</p>
</td><td class=code><div class=highlight><pre>
    sudo iscsiadm --mode node | grep <span class="nv">$VOLUME_NAME_PREFIX</span> | cut -d <span class="s2">&quot; &quot;</span> -f2 | xargs sudo iscsiadm --mode node --logout <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>sudo iscsiadm --mode node | grep <span class="nv">$VOLUME_NAME_PREFIX</span> | cut -d <span class="s2">&quot; &quot;</span> -f2 | sudo iscsiadm --mode node --op delete <span class="o">||</span> <span class="nb">true</span>

</pre></div></td></tr><tr><td class=docs>
<p>Clean out the instances directory.</p>
</td><td class=code><div class=highlight><pre>
    sudo rm -rf <span class="nv">$NOVA_DIR</span>/instances/*
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled n-net; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Delete traces of nova networks from prior runs</p>
</td><td class=code><div class=highlight><pre>
    sudo killall dnsmasq <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>clean_iptables
    rm -rf <span class="nv">$NOVA_DIR</span>/networks
    mkdir -p <span class="nv">$NOVA_DIR</span>/networks

</pre></div></td></tr><tr><td class=docs>
<p>Force IP forwarding on, just on case</p>
</td><td class=code><div class=highlight><pre>
    sudo sysctl -w net.ipv4.ip_forward<span class="o">=</span>1
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Storage Service</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>We first do a bit of setup by creating the directories and
changing the permissions so we can run it as our user.</p>
</td><td class=code><div class=highlight><pre>

    <span class="nv">USER_GROUP</span><span class="o">=</span><span class="k">$(</span>id -g<span class="k">)</span>
    sudo mkdir -p <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives
    sudo chown -R <span class="nv">$USER</span>:<span class="k">${</span><span class="nv">USER_GROUP</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>We then create a loopback disk and format it to XFS.
TODO: Reset disks on new pass.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> ! -e <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/images/swift.img <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>mkdir -p  <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/images
        sudo touch  <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/images/swift.img
        sudo chown <span class="nv">$USER</span>: <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/images/swift.img

        dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/images/swift.img <span class="se">\</span>
            <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span>0 <span class="nv">seek</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_LOOPBACK_DISK_SIZE</span><span class="k">}</span>
        mkfs.xfs -f -i <span class="nv">size</span><span class="o">=</span>1024  <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/images/swift.img
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>After the drive being created we mount the disk with a few mount
options to make it most efficient as possible for swift.</p>
</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/sdb1
    <span class="k">if</span> ! egrep -q <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/sdb1 /proc/mounts; <span class="k">then</span>
<span class="k">        </span>sudo mount -t xfs -o loop,noatime,nodiratime,nobarrier,logbufs<span class="o">=</span>8  <span class="se">\</span>
            <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/images/swift.img <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/sdb1
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>We then create link to that mounted location so swift would know
where to go.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">        </span>sudo ln -sf <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/sdb1/<span class="nv">$x</span> <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/<span class="nv">$x</span>; <span class="k">done</span>

</pre></div></td></tr><tr><td class=docs>
<p>We now have to emulate a few different servers into one we
create all the directories needed for swift</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            </span><span class="nv">drive</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/sdb1/<span class="k">${</span><span class="nv">x</span><span class="k">}</span>
            <span class="nv">node</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/<span class="k">${</span><span class="nv">x</span><span class="k">}</span>/node
            <span class="nv">node_device</span><span class="o">=</span><span class="k">${</span><span class="nv">node</span><span class="k">}</span>/sdb1
            <span class="o">[[</span> -d <span class="nv">$node</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
            <span class="o">[[</span> -d <span class="nv">$drive</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
<span class="k">            </span>sudo install -o <span class="k">${</span><span class="nv">USER</span><span class="k">}</span> -g <span class="nv">$USER_GROUP</span> -d <span class="nv">$drive</span>
            sudo install -o <span class="k">${</span><span class="nv">USER</span><span class="k">}</span> -g <span class="nv">$USER_GROUP</span> -d <span class="nv">$node_device</span>
            sudo chown -R <span class="nv">$USER</span>: <span class="k">${</span><span class="nv">node</span><span class="k">}</span>
    <span class="k">done</span>

<span class="k">   </span>sudo mkdir -p <span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">}</span>/<span class="o">{</span>object,container,account<span class="o">}</span>-server /var/run/swift
   sudo chown -R <span class="nv">$USER</span>: <span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">}</span> /var/run/swift

</pre></div></td></tr><tr><td class=docs>
<p>swift-init has a bug using /etc/swift until bug #885595 is fixed
we have to create a link</p>
</td><td class=code><div class=highlight><pre>
   sudo ln -sf <span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">}</span> /etc/swift

</pre></div></td></tr><tr><td class=docs>
<p>Swift use rsync to syncronize between all the different
partitions (which make more sense when you have a multi-node
setup) we configure it with our version of rsync.</p>
</td><td class=code><div class=highlight><pre>
   sed -e <span class="s2">&quot;s/%GROUP%/${USER_GROUP}/;s/%USER%/$USER/;s,%SWIFT_DATA_LOCATION%,$SWIFT_DATA_LOCATION,&quot;</span> <span class="nv">$FILES</span>/swift/rsyncd.conf | sudo tee /etc/rsyncd.conf
   sudo sed -i <span class="s1">&#39;/^RSYNC_ENABLE=false/ { s/false/true/ }&#39;</span> /etc/default/rsync

</pre></div></td></tr><tr><td class=docs>
<p>By default Swift will be installed with the tempauth middleware
which has some default username and password if you have
configured keystone it will checkout the directory.</p>
</td><td class=code><div class=highlight><pre>
   <span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">       </span><span class="nv">swift_auth_server</span><span class="o">=</span><span class="s2">&quot;s3token tokenauth keystone&quot;</span>
   <span class="k">else</span>
<span class="k">       </span><span class="nv">swift_auth_server</span><span class="o">=</span>tempauth
   <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>We do the install of the proxy-server and swift configuration
replacing a few directives to match our configuration.</p>
</td><td class=code><div class=highlight><pre>
   sed -e <span class="s2">&quot;</span>
<span class="s2">       s,%SWIFT_CONFIG_LOCATION%,${SWIFT_CONFIG_LOCATION},g;</span>
<span class="s2">       s,%USER%,$USER,g;</span>
<span class="s2">       s,%SERVICE_TENANT_NAME%,$SERVICE_TENANT_NAME,g;</span>
<span class="s2">       s,%SERVICE_USERNAME%,swift,g;</span>
<span class="s2">       s,%SERVICE_PASSWORD%,$SERVICE_PASSWORD,g;</span>
<span class="s2">       s,%SERVICE_TOKEN%,${SERVICE_TOKEN},g;</span>
<span class="s2">       s,%KEYSTONE_SERVICE_PORT%,${KEYSTONE_SERVICE_PORT},g;</span>
<span class="s2">       s,%KEYSTONE_SERVICE_HOST%,${KEYSTONE_SERVICE_HOST},g;</span>
<span class="s2">       s,%KEYSTONE_API_PORT%,${KEYSTONE_API_PORT},g;</span>
<span class="s2">       s,%KEYSTONE_AUTH_HOST%,${KEYSTONE_AUTH_HOST},g;</span>
<span class="s2">       s,%KEYSTONE_AUTH_PORT%,${KEYSTONE_AUTH_PORT},g;</span>
<span class="s2">       s,%KEYSTONE_AUTH_PROTOCOL%,${KEYSTONE_AUTH_PROTOCOL},g;</span>
<span class="s2">       s/%AUTH_SERVER%/${swift_auth_server}/g;</span>
<span class="s2">    &quot;</span> <span class="nv">$FILES</span>/swift/proxy-server.conf | <span class="se">\</span>
       sudo tee  <span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">}</span>/proxy-server.conf

   sed -e <span class="s2">&quot;s/%SWIFT_HASH%/$SWIFT_HASH/&quot;</span> <span class="nv">$FILES</span>/swift/swift.conf &gt; <span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">}</span>/swift.conf

</pre></div></td></tr><tr><td class=docs>
<p>We need to generate a object/account/proxy configuration
emulating 4 nodes on different ports we have a little function
that help us doing that.</p>
</td><td class=code><div class=highlight><pre>
   <span class="k">function </span>generate_swift_configuration<span class="o">()</span> <span class="o">{</span>
       <span class="nb">local </span><span class="nv">server_type</span><span class="o">=</span><span class="nv">$1</span>
       <span class="nb">local </span><span class="nv">bind_port</span><span class="o">=</span><span class="nv">$2</span>
       <span class="nb">local </span><span class="nv">log_facility</span><span class="o">=</span><span class="nv">$3</span>
       <span class="nb">local </span>node_number

       <span class="k">for </span>node_number in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">           </span><span class="nv">node_path</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>
           sed -e <span class="s2">&quot;s,%SWIFT_CONFIG_LOCATION%,${SWIFT_CONFIG_LOCATION},;s,%USER%,$USER,;s,%NODE_PATH%,${node_path},;s,%BIND_PORT%,${bind_port},;s,%LOG_FACILITY%,${log_facility},&quot;</span> <span class="se">\</span>
               <span class="nv">$FILES</span>/swift/<span class="k">${</span><span class="nv">server_type</span><span class="k">}</span>-server.conf &gt; <span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">}</span>/<span class="k">${</span><span class="nv">server_type</span><span class="k">}</span>-server/<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>.conf
           <span class="nv">bind_port</span><span class="o">=</span><span class="k">$((</span> <span class="k">${</span><span class="nv">bind_port</span><span class="k">}</span> <span class="o">+</span> <span class="m">10</span> <span class="k">))</span>
           <span class="nv">log_facility</span><span class="o">=</span><span class="k">$((</span> <span class="k">${</span><span class="nv">log_facility</span><span class="k">}</span> <span class="o">+</span> <span class="m">1</span> <span class="k">))</span>
       <span class="k">done</span>
   <span class="o">}</span>
   generate_swift_configuration object 6010 2
   generate_swift_configuration container 6011 2
   generate_swift_configuration account 6012 2


</pre></div></td></tr><tr><td class=docs>
<p>We have some specific configuration for swift for rsyslog. See
the file /etc/rsyslog.d/10-swift.conf for more info.</p>
</td><td class=code><div class=highlight><pre>
   <span class="nv">swift_log_dir</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/logs
   rm -rf <span class="k">${</span><span class="nv">swift_log_dir</span><span class="k">}</span>
   mkdir -p <span class="k">${</span><span class="nv">swift_log_dir</span><span class="k">}</span>/hourly
   sudo chown -R syslog:adm <span class="k">${</span><span class="nv">swift_log_dir</span><span class="k">}</span>
   sed <span class="s2">&quot;s,%SWIFT_LOGDIR%,${swift_log_dir},&quot;</span> <span class="nv">$FILES</span>/swift/rsyslog.conf | sudo <span class="se">\</span>
       tee /etc/rsyslog.d/10-swift.conf
   sudo restart rsyslog

</pre></div></td></tr><tr><td class=docs>
<p>This is where we create three different rings for swift with
different object servers binding on different ports.</p>
</td><td class=code><div class=highlight><pre>
   <span class="nb">pushd</span> <span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">}</span> &gt;/dev/null <span class="o">&amp;&amp;</span> <span class="o">{</span>

       rm -f *.builder *.ring.gz backups/*.builder backups/*.ring.gz

       <span class="nv">port_number</span><span class="o">=</span>6010
       swift-ring-builder object.builder create <span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">}</span> 1
       <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">           </span>swift-ring-builder object.builder add z<span class="k">${</span><span class="nv">x</span><span class="k">}</span>-127.0.0.1:<span class="k">${</span><span class="nv">port_number</span><span class="k">}</span>/sdb1 1
           <span class="nv">port_number</span><span class="o">=</span><span class="nv">$[</span>port_number + 10<span class="o">]</span>
       <span class="k">done</span>
<span class="k">       </span>swift-ring-builder object.builder rebalance

       <span class="nv">port_number</span><span class="o">=</span>6011
       swift-ring-builder container.builder create <span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">}</span> 1
       <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">           </span>swift-ring-builder container.builder add z<span class="k">${</span><span class="nv">x</span><span class="k">}</span>-127.0.0.1:<span class="k">${</span><span class="nv">port_number</span><span class="k">}</span>/sdb1 1
           <span class="nv">port_number</span><span class="o">=</span><span class="nv">$[</span>port_number + 10<span class="o">]</span>
       <span class="k">done</span>
<span class="k">       </span>swift-ring-builder container.builder rebalance

       <span class="nv">port_number</span><span class="o">=</span>6012
       swift-ring-builder account.builder create <span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">}</span> 1
       <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">           </span>swift-ring-builder account.builder add z<span class="k">${</span><span class="nv">x</span><span class="k">}</span>-127.0.0.1:<span class="k">${</span><span class="nv">port_number</span><span class="k">}</span>/sdb1 1
           <span class="nv">port_number</span><span class="o">=</span><span class="nv">$[</span>port_number + 10<span class="o">]</span>
       <span class="k">done</span>
<span class="k">       </span>swift-ring-builder account.builder rebalance

   <span class="o">}</span> <span class="o">&amp;&amp;</span> <span class="nb">popd</span> &gt;/dev/null

   sudo chmod +x /usr/local/bin/swift-*

</pre></div></td></tr><tr><td class=docs>
<p>We then can start rsync.</p>
</td><td class=code><div class=highlight><pre>
   sudo /etc/init.d/rsync restart <span class="o">||</span> :

</pre></div></td></tr><tr><td class=docs>
<p>TODO: Bring some services in foreground.
Launch all services.</p>
</td><td class=code><div class=highlight><pre>
   swift-init all start

   <span class="nb">unset </span>s swift_hash swift_auth_server
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="volume-service">
<h2>Volume Service</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled n-vol; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Configure a default volume group called 'nova-volumes' for the nova-volume
service if it does not yet exist.  If you don't wish to use a file backed
volume group, create your own volume group called 'nova-volumes' before
invoking stack.sh.</p>
<p>By default, the backing file is 2G in size, and is stored in /opt/stack.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>install the package</p>
</td><td class=code><div class=highlight><pre>
    apt_get install tgt

    <span class="k">if</span> ! sudo vgs <span class="nv">$VOLUME_GROUP</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">VOLUME_BACKING_FILE</span><span class="o">=</span><span class="k">${</span><span class="nv">VOLUME_BACKING_FILE</span><span class="k">:-</span><span class="nv">$DEST</span><span class="p">/nova-volumes-backing-file</span><span class="k">}</span>
        <span class="nv">VOLUME_BACKING_FILE_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">VOLUME_BACKING_FILE_SIZE</span><span class="k">:-</span><span class="nv">2052M</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Only create if the file doesn't already exists</p>
</td><td class=code><div class=highlight><pre>
        <span class="o">[[</span> -f <span class="nv">$VOLUME_BACKING_FILE</span> <span class="o">]]</span> <span class="o">||</span> truncate -s <span class="nv">$VOLUME_BACKING_FILE_SIZE</span> <span class="nv">$VOLUME_BACKING_FILE</span>
        <span class="nv">DEV</span><span class="o">=</span><span class="sb">`</span>sudo losetup -f --show <span class="nv">$VOLUME_BACKING_FILE</span><span class="sb">`</span>
</pre></div></td></tr><tr><td class=docs>
<p>Only create if the loopback device doesn't contain $VOLUME_GROUP</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> ! sudo vgs <span class="nv">$VOLUME_GROUP</span>; <span class="k">then </span>sudo vgcreate <span class="nv">$VOLUME_GROUP</span> <span class="nv">$DEV</span>; <span class="k">fi</span>
<span class="k">    fi</span>

<span class="k">    if </span>sudo vgs <span class="nv">$VOLUME_GROUP</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Remove nova iscsi targets</p>
</td><td class=code><div class=highlight><pre>
        sudo tgtadm --op show --mode target | grep <span class="nv">$VOLUME_NAME_PREFIX</span> | grep Target | cut -f3 -d <span class="s1">&#39; &#39;</span> | sudo xargs -n1 tgt-admin --delete <span class="o">||</span> <span class="nb">true</span>
</pre></div></td></tr><tr><td class=docs>
<p>Clean out existing volumes</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">for </span>lv in <span class="sb">`</span>sudo lvs --noheadings -o lv_name <span class="nv">$VOLUME_GROUP</span><span class="sb">`</span>; <span class="k">do</span>
</pre></div></td></tr><tr><td class=docs>
<p>VOLUME_NAME_PREFIX prefixes the LVs we want</p>
</td><td class=code><div class=highlight><pre>
            <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;${lv#$VOLUME_NAME_PREFIX}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;$lv&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span>sudo lvremove -f <span class="nv">$VOLUME_GROUP</span>/<span class="nv">$lv</span>
            <span class="k">fi</span>
<span class="k">        done</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>tgt in oneiric doesn't restart properly if tgtd isn't running
do it in two steps</p>
</td><td class=code><div class=highlight><pre>
    sudo stop tgt <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>sudo start tgt
<span class="k">fi</span>

<span class="nv">NOVA_CONF</span><span class="o">=</span>nova.conf
<span class="k">function </span>add_nova_opt <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;$1&quot;</span> &gt;&gt; <span class="nv">$NOVA_CONF_DIR</span>/<span class="nv">$NOVA_CONF</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>remove legacy nova.conf</p>
</td><td class=code><div class=highlight><pre>
rm -f <span class="nv">$NOVA_DIR</span>/bin/nova.conf

</pre></div></td></tr><tr><td class=docs>
<p>(re)create nova.conf</p>
</td><td class=code><div class=highlight><pre>
rm -f <span class="nv">$NOVA_CONF_DIR</span>/<span class="nv">$NOVA_CONF</span>
add_nova_opt <span class="s2">&quot;[DEFAULT]&quot;</span>
add_nova_opt <span class="s2">&quot;verbose=True&quot;</span>
add_nova_opt <span class="s2">&quot;auth_strategy=keystone&quot;</span>
add_nova_opt <span class="s2">&quot;allow_resize_to_same_host=True&quot;</span>
add_nova_opt <span class="s2">&quot;root_helper=sudo /usr/local/bin/nova-rootwrap&quot;</span>
add_nova_opt <span class="s2">&quot;compute_scheduler_driver=$SCHEDULER&quot;</span>
add_nova_opt <span class="s2">&quot;dhcpbridge_flagfile=$NOVA_CONF_DIR/$NOVA_CONF&quot;</span>
add_nova_opt <span class="s2">&quot;fixed_range=$FIXED_RANGE&quot;</span>
<span class="k">if </span>is_service_enabled n-obj; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;s3_host=$SERVICE_HOST&quot;</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;network_manager=nova.network.quantum.manager.QuantumManager&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_connection_host=$Q_HOST&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_connection_port=$Q_PORT&quot;</span>

    <span class="k">if </span>is_service_enabled melange; <span class="k">then</span>
<span class="k">        </span>add_nova_opt <span class="s2">&quot;quantum_ipam_lib=nova.network.quantum.melange_ipam_lib&quot;</span>
        add_nova_opt <span class="s2">&quot;use_melange_mac_generation=True&quot;</span>
        add_nova_opt <span class="s2">&quot;melange_host=$M_HOST&quot;</span>
        add_nova_opt <span class="s2">&quot;melange_port=$M_PORT&quot;</span>
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-svc <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>add_nova_opt <span class="s2">&quot;libvirt_vif_type=ethernet&quot;</span>
        add_nova_opt <span class="s2">&quot;libvirt_vif_driver=nova.virt.libvirt.vif.LibvirtOpenVswitchDriver&quot;</span>
        add_nova_opt <span class="s2">&quot;linuxnet_interface_driver=nova.network.linux_net.LinuxOVSInterfaceDriver&quot;</span>
        add_nova_opt <span class="s2">&quot;quantum_use_dhcp=True&quot;</span>
    <span class="k">fi</span>
<span class="k">else</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;network_manager=nova.network.manager.$NET_MAN&quot;</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled n-vol; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;volume_group=$VOLUME_GROUP&quot;</span>
    add_nova_opt <span class="s2">&quot;volume_name_template=${VOLUME_NAME_PREFIX}%08x&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>oneiric no longer supports ietadm</p>
</td><td class=code><div class=highlight><pre>
    add_nova_opt <span class="s2">&quot;iscsi_helper=tgtadm&quot;</span>
<span class="k">fi</span>
add_nova_opt <span class="s2">&quot;osapi_compute_extension=nova.api.openstack.compute.contrib.standard_extensions&quot;</span>
add_nova_opt <span class="s2">&quot;my_ip=$HOST_IP&quot;</span>
add_nova_opt <span class="s2">&quot;public_interface=$PUBLIC_INTERFACE&quot;</span>
add_nova_opt <span class="s2">&quot;vlan_interface=$VLAN_INTERFACE&quot;</span>
add_nova_opt <span class="s2">&quot;flat_network_bridge=$FLAT_NETWORK_BRIDGE&quot;</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$FLAT_INTERFACE&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;flat_interface=$FLAT_INTERFACE&quot;</span>
<span class="k">fi</span>
add_nova_opt <span class="s2">&quot;sql_connection=$BASE_SQL_CONN/nova&quot;</span>
add_nova_opt <span class="s2">&quot;libvirt_type=$LIBVIRT_TYPE&quot;</span>
add_nova_opt <span class="s2">&quot;instance_name_template=${INSTANCE_NAME_PREFIX}%08x&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>All nova-compute workers need to know the vnc configuration options
These settings don't hurt anything if n-xvnc and n-novnc are disabled</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled n-cpu; <span class="k">then</span>
<span class="k">    </span><span class="nv">NOVNCPROXY_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVNCPROXY_URL</span><span class="k">:-</span><span class="s2">&quot;http://$SERVICE_HOST:6080/vnc_auto.html&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;novncproxy_base_url=$NOVNCPROXY_URL&quot;</span>
    <span class="nv">XVPVNCPROXY_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">XVPVNCPROXY_URL</span><span class="k">:-</span><span class="s2">&quot;http://$SERVICE_HOST:6081/console&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;xvpvncproxy_base_url=$XVPVNCPROXY_URL&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="p">=169.254.0.1</span><span class="k">}</span>
<span class="k">else</span>
<span class="k">    </span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="p">=127.0.0.1</span><span class="k">}</span>
<span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Address on which instance vncservers will listen on compute hosts.
For multi-host, this should be the management ip of the compute host.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">VNCSERVER_LISTEN</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_LISTEN</span><span class="p">=127.0.0.1</span><span class="k">}</span>
add_nova_opt <span class="s2">&quot;vncserver_listen=$VNCSERVER_LISTEN&quot;</span>
add_nova_opt <span class="s2">&quot;vncserver_proxyclient_address=$VNCSERVER_PROXYCLIENT_ADDRESS&quot;</span>
add_nova_opt <span class="s2">&quot;api_paste_config=$NOVA_CONF_DIR/api-paste.ini&quot;</span>
add_nova_opt <span class="s2">&quot;image_service=nova.image.glance.GlanceImageService&quot;</span>
add_nova_opt <span class="s2">&quot;ec2_dmz_host=$EC2_DMZ_HOST&quot;</span>
add_nova_opt <span class="s2">&quot;rabbit_host=$RABBIT_HOST&quot;</span>
add_nova_opt <span class="s2">&quot;rabbit_password=$RABBIT_PASSWORD&quot;</span>
add_nova_opt <span class="s2">&quot;glance_api_servers=$GLANCE_HOSTPORT&quot;</span>
add_nova_opt <span class="s2">&quot;force_dhcp_release=True&quot;</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$INSTANCES_PATH&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;instances_path=$INSTANCES_PATH&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$MULTI_HOST&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;multi_host=True&quot;</span>
    add_nova_opt <span class="s2">&quot;send_arp_for_ha=True&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$SYSLOG&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;use_syslog=True&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Provide some transition from EXTRA_FLAGS to EXTRA_OPTS</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$EXTRA_OPTS&quot;</span> <span class="o">&amp;&amp;</span> -n <span class="s2">&quot;$EXTRA_FLAGS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">	</span><span class="nv">EXTRA_OPTS</span><span class="o">=</span><span class="nv">$EXTRA_FLAGS</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>You can define extra nova conf flags by defining the array EXTRA_OPTS,
For Example: EXTRA_OPTS=(foo=true bar=2)</p>
</td><td class=code><div class=highlight><pre>
<span class="k">for </span>I in <span class="s2">&quot;${EXTRA_OPTS[@]}&quot;</span>; <span class="k">do</span>
</pre></div></td></tr><tr><td class=docs>
<p>Attempt to convert flags to options</p>
</td><td class=code><div class=highlight><pre>
    add_nova_opt <span class="k">${</span><span class="nv">I</span><span class="p">//-</span><span class="k">}</span>
<span class="k">done</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="xenserver">
<h2>XenServer</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>read_password XENAPI_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR XEN.&quot;</span>
    add_nova_opt <span class="s2">&quot;connection_type=xenapi&quot;</span>
    <span class="nv">XENAPI_CONNECTION_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">XENAPI_CONNECTION_URL</span><span class="k">:-</span><span class="s2">&quot;http://169.254.0.1&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;xenapi_connection_url=$XENAPI_CONNECTION_URL&quot;</span>
    add_nova_opt <span class="s2">&quot;xenapi_connection_username=root&quot;</span>
    add_nova_opt <span class="s2">&quot;xenapi_connection_password=$XENAPI_PASSWORD&quot;</span>
    add_nova_opt <span class="s2">&quot;flat_injected=False&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Need to avoid crash due to new firewall support</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">XEN_FIREWALL_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">XEN_FIREWALL_DRIVER</span><span class="k">:-</span><span class="s2">&quot;nova.virt.firewall.IptablesFirewallDriver&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;firewall_driver=$XEN_FIREWALL_DRIVER&quot;</span>
<span class="k">else</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;connection_type=libvirt&quot;</span>
    <span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="k">:-</span><span class="s2">&quot;nova.virt.libvirt.firewall.IptablesFirewallDriver&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;firewall_driver=$LIBVIRT_FIREWALL_DRIVER&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<div class="section" id="nova-database">
<h3>Nova Database</h3>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>All nova components talk to a central database.  We will need to do this step
only once for an entire cluster.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled mysql; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>(re)create nova database</p>
</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS nova;&#39;</span>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;CREATE DATABASE nova;&#39;</span>

</pre></div></td></tr><tr><td class=docs>
<p>(re)create nova database</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_DIR</span>/bin/nova-manage db sync
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
</div>
<div class="section" id="launch-services">
<h1>Launch Services</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>nova api crashes if we start it with a regular screen command,
so send the start command by forcing text into the window.
Only run the services specified in <tt class="docutils literal">ENABLED_SERVICES</tt></p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Our screenrc file builder</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>screen_rc <span class="o">{</span>
    <span class="nv">SCREENRC</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/stack-screenrc
    <span class="k">if</span> <span class="o">[[</span> ! -e <span class="nv">$SCREENRC</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Name the screen session</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s2">&quot;sessionname stack&quot;</span> &gt; <span class="nv">$SCREENRC</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set a reasonable statusbar</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s1">&#39;hardstatus alwayslastline &quot;%-Lw%{= BW}%50&gt;%n%f* %t%{-}%+Lw%&lt; %= %H&quot;&#39;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
        <span class="nb">echo</span> <span class="s2">&quot;screen -t stack bash&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>If this service doesn't already exist in the screenrc file</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> ! grep <span class="nv">$1</span> <span class="nv">$SCREENRC</span> 2&gt;&amp;1 &gt; /dev/null; <span class="k">then</span>
<span class="k">        </span><span class="nv">NL</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -ne <span class="s1">&#39;\015&#39;</span><span class="sb">`</span>
        <span class="nb">echo</span> <span class="s2">&quot;screen -t $1 bash&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
        <span class="nb">echo</span> <span class="s2">&quot;stuff \&quot;$2$NL\&quot;&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Our screen helper to launch a service in a hidden named screen</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>screen_it <span class="o">{</span>
    <span class="nv">NL</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -ne <span class="s1">&#39;\015&#39;</span><span class="sb">`</span>
    <span class="k">if </span>is_service_enabled <span class="nv">$1</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Append the service to the screen rc file</p>
</td><td class=code><div class=highlight><pre>
        screen_rc <span class="s2">&quot;$1&quot;</span> <span class="s2">&quot;$2&quot;</span>

        screen -S stack -X screen -t <span class="nv">$1</span>
</pre></div></td></tr><tr><td class=docs>
<p>sleep to allow bash to be ready to be send the command - we are
creating a new window in screen and then sends characters, so if
bash isn't running by the time we send the command, nothing happens</p>
</td><td class=code><div class=highlight><pre>
        sleep 1.5

        <span class="k">if</span> <span class="o">[[</span> -n <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>screen -S stack -p <span class="nv">$1</span> -X logfile <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.log
            screen -S stack -p <span class="nv">$1</span> -X log on
            ln -sf <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.log <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.log
        <span class="k">fi</span>
<span class="k">        </span>screen -S stack -p <span class="nv">$1</span> -X stuff <span class="s2">&quot;$2$NL&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>create a new named screen to run processes in</p>
</td><td class=code><div class=highlight><pre>
screen -d -m -S stack -t stack -s /bin/bash
sleep 1
</pre></div></td></tr><tr><td class=docs>
<p>set a reasonable statusbar</p>
</td><td class=code><div class=highlight><pre>
screen -r stack -X hardstatus alwayslastline <span class="s2">&quot;%-Lw%{= BW}%50&gt;%n%f* %t%{-}%+Lw%&lt; %= %H&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>launch the glance registry service</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
<span class="k">    </span>screen_it g-reg <span class="s2">&quot;cd $GLANCE_DIR; bin/glance-registry --config-file=etc/glance-registry.conf&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>launch the glance api and wait for it to answer before continuing</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled g-api; <span class="k">then</span>
<span class="k">    </span>screen_it g-api <span class="s2">&quot;cd $GLANCE_DIR; bin/glance-api --config-file=etc/glance-api.conf&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for g-api ($GLANCE_HOSTPORT) to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= wget -q -O- http://$GLANCE_HOSTPORT; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;g-api did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>(re)create keystone database</p>
</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS keystone;&#39;</span>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;CREATE DATABASE keystone;&#39;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure keystone.conf</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">KEYSTONE_CONF</span><span class="o">=</span><span class="nv">$KEYSTONE_DIR</span>/etc/keystone.conf
    cp <span class="nv">$FILES</span>/keystone.conf <span class="nv">$KEYSTONE_CONF</span>
    sudo sed -e <span class="s2">&quot;s,%SQL_CONN%,$BASE_SQL_CONN/keystone,g&quot;</span> -i <span class="nv">$KEYSTONE_CONF</span>
    sudo sed -e <span class="s2">&quot;s,%DEST%,$DEST,g&quot;</span> -i <span class="nv">$KEYSTONE_CONF</span>
    sudo sed -e <span class="s2">&quot;s,%SERVICE_TOKEN%,$SERVICE_TOKEN,g&quot;</span> -i <span class="nv">$KEYSTONE_CONF</span>
    sudo sed -e <span class="s2">&quot;s,%KEYSTONE_DIR%,$KEYSTONE_DIR,g&quot;</span> -i <span class="nv">$KEYSTONE_CONF</span>

    <span class="nv">KEYSTONE_CATALOG</span><span class="o">=</span><span class="nv">$KEYSTONE_DIR</span>/etc/default_catalog.templates
    cp <span class="nv">$FILES</span>/default_catalog.templates <span class="nv">$KEYSTONE_CATALOG</span>

</pre></div></td></tr><tr><td class=docs>
<p>Add swift endpoints to service catalog if swift is enabled</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.object_store.publicURL = http://%SERVICE_HOST%:8080/v1/AUTH_\$(tenant_id)s&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
        <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.object_store.adminURL = http://%SERVICE_HOST%:8080/&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
        <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.object_store.internalURL = http://%SERVICE_HOST%:8080/v1/AUTH_\$(tenant_id)s&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
        <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.object_store.name = &#39;Swift Service&#39;&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Add quantum endpoints to service catalog if quantum is enabled</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.network.publicURL = http://%SERVICE_HOST%:9696/&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
        <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.network.adminURL = http://%SERVICE_HOST%:9696/&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
        <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.network.internalURL = http://%SERVICE_HOST%:9696/&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
        <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.network.name = &#39;Quantum Service&#39;&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
    <span class="k">fi</span>

<span class="k">    </span>sudo sed -e <span class="s2">&quot;s,%SERVICE_HOST%,$SERVICE_HOST,g&quot;</span> -i <span class="nv">$KEYSTONE_CATALOG</span>


    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$SYSLOG&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>cp <span class="nv">$KEYSTONE_DIR</span>/etc/logging.conf.sample <span class="nv">$KEYSTONE_DIR</span>/etc/logging.conf
        sed -i -e <span class="s1">&#39;/^handlers=devel$/s/=devel/=production/&#39;</span> <span class="se">\</span>
            <span class="nv">$KEYSTONE_DIR</span>/etc/logging.conf
        sed -i -e <span class="s2">&quot;/^log_file/s/log_file/\#log_file/&quot;</span> <span class="se">\</span>
            <span class="nv">$KEYSTONE_DIR</span>/etc/keystone.conf
        <span class="nv">KEYSTONE_LOG_CONFIG</span><span class="o">=</span><span class="s2">&quot;--log-config $KEYSTONE_DIR/etc/logging.conf&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>launch the keystone and wait for it to answer before continuing</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">    </span>screen_it key <span class="s2">&quot;cd $KEYSTONE_DIR &amp;&amp; $KEYSTONE_DIR/bin/keystone-all --config-file $KEYSTONE_CONF $KEYSTONE_LOG_CONFIG -d --debug&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for keystone to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= wget -q -O- $KEYSTONE_AUTH_PROTOCOL://$SERVICE_HOST:$KEYSTONE_API_PORT/v2.0/; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;keystone did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>initialize keystone with default users/endpoints</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">pushd</span> <span class="nv">$KEYSTONE_DIR</span>
    <span class="nv">$KEYSTONE_DIR</span>/bin/keystone-manage db_sync
    <span class="nb">popd</span>

</pre></div></td></tr><tr><td class=docs>
<p>keystone_data.sh creates services, admin and demo users, and roles.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">SERVICE_ENDPOINT</span><span class="o">=</span><span class="nv">$KEYSTONE_AUTH_PROTOCOL</span>://<span class="nv">$KEYSTONE_AUTH_HOST</span>:<span class="nv">$KEYSTONE_AUTH_PORT</span>/v2.0
    <span class="nv">ADMIN_PASSWORD</span><span class="o">=</span><span class="nv">$ADMIN_PASSWORD</span> <span class="nv">SERVICE_TENANT_NAME</span><span class="o">=</span><span class="nv">$SERVICE_TENANT_NAME</span> <span class="nv">SERVICE_PASSWORD</span><span class="o">=</span><span class="nv">$SERVICE_PASSWORD</span> <span class="nv">SERVICE_TOKEN</span><span class="o">=</span><span class="nv">$SERVICE_TOKEN</span> <span class="nv">SERVICE_ENDPOINT</span><span class="o">=</span><span class="nv">$SERVICE_ENDPOINT</span> <span class="nv">DEVSTACK_DIR</span><span class="o">=</span><span class="nv">$TOP_DIR</span> <span class="nv">ENABLED_SERVICES</span><span class="o">=</span><span class="nv">$ENABLED_SERVICES</span> <span class="se">\</span>
        bash <span class="nv">$FILES</span>/keystone_data.sh
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>launch the nova-api and wait for it to answer before continuing</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled n-api; <span class="k">then</span>
<span class="k">    </span>screen_it n-api <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-api&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for nova-api to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= wget -q -O- http://127.0.0.1:8774; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;nova-api did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Quantum service</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled q-svc; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Install deps
FIXME add to files/apts/quantum, but don't install if not needed!</p>
</td><td class=code><div class=highlight><pre>
        apt_get install openvswitch-switch openvswitch-datapath-dkms
</pre></div></td></tr><tr><td class=docs>
<p>Create database for the plugin/agent</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if </span>is_service_enabled mysql; <span class="k">then</span>
<span class="k">            </span>mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS ovs_quantum;&#39;</span>
            mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;CREATE DATABASE IF NOT EXISTS ovs_quantum;&#39;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;mysql must be enabled in order to use the $Q_PLUGIN Quantum plugin.&quot;</span>
            <span class="nb">exit </span>1
        <span class="k">fi</span>
<span class="k">        </span><span class="nv">QUANTUM_PLUGIN_INI_FILE</span><span class="o">=</span><span class="nv">$QUANTUM_DIR</span>/etc/plugins.ini
</pre></div></td></tr><tr><td class=docs>
<p>Make sure we're using the openvswitch plugin</p>
</td><td class=code><div class=highlight><pre>
        sed -i -e <span class="s2">&quot;s/^provider =.*$/provider = quantum.plugins.openvswitch.ovs_quantum_plugin.OVSQuantumPlugin/g&quot;</span> <span class="nv">$QUANTUM_PLUGIN_INI_FILE</span>
    <span class="k">fi</span>
<span class="k">   </span>screen_it q-svc <span class="s2">&quot;cd $QUANTUM_DIR &amp;&amp; PYTHONPATH=.:$QUANTUM_CLIENT_DIR:$PYTHONPATH python $QUANTUM_DIR/bin/quantum-server $QUANTUM_DIR/etc/quantum.conf&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Quantum agent (for compute nodes)</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled q-agt; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set up integration bridge</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">OVS_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">OVS_BRIDGE</span><span class="k">:-</span><span class="nv">br</span><span class="p">-int</span><span class="k">}</span>
        sudo ovs-vsctl --no-wait -- --if-exists del-br <span class="nv">$OVS_BRIDGE</span>
        sudo ovs-vsctl --no-wait add-br <span class="nv">$OVS_BRIDGE</span>
        sudo ovs-vsctl --no-wait br-set-external-id <span class="nv">$OVS_BRIDGE</span> bridge-id br-int

</pre></div></td></tr><tr><td class=docs>
<p>Start up the quantum &lt;-&gt; openvswitch agent</p>
</td><td class=code><div class=highlight><pre>
       <span class="nv">QUANTUM_OVS_CONFIG_FILE</span><span class="o">=</span><span class="nv">$QUANTUM_DIR</span>/etc/quantum/plugins/openvswitch/ovs_quantum_plugin.ini
       sed -i -e <span class="s2">&quot;s/^sql_connection =.*$/sql_connection = mysql:\/\/$MYSQL_USER:$MYSQL_PASSWORD@$MYSQL_HOST\/ovs_quantum/g&quot;</span> <span class="nv">$QUANTUM_OVS_CONFIG_FILE</span>
       screen_it q-agt <span class="s2">&quot;sleep 4; sudo python $QUANTUM_DIR/quantum/plugins/openvswitch/agent/ovs_quantum_agent.py $QUANTUM_OVS_CONFIG_FILE -v&quot;</span>
    <span class="k">fi</span>

<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Melange service</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled m-svc; <span class="k">then</span>
<span class="k">    if </span>is_service_enabled mysql; <span class="k">then</span>
<span class="k">        </span>mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS melange;&#39;</span>
        mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;CREATE DATABASE melange;&#39;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;mysql must be enabled in order to use the $Q_PLUGIN Quantum plugin.&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">    </span><span class="nv">MELANGE_CONFIG_FILE</span><span class="o">=</span><span class="nv">$MELANGE_DIR</span>/etc/melange/melange.conf
    cp <span class="nv">$MELANGE_CONFIG_FILE</span>.sample <span class="nv">$MELANGE_CONFIG_FILE</span>
    sed -i -e <span class="s2">&quot;s/^sql_connection =.*$/sql_connection = mysql:\/\/$MYSQL_USER:$MYSQL_PASSWORD@$MYSQL_HOST\/melange/g&quot;</span> <span class="nv">$MELANGE_CONFIG_FILE</span>
    <span class="nb">cd</span> <span class="nv">$MELANGE_DIR</span> <span class="o">&amp;&amp;</span> <span class="nv">PYTHONPATH</span><span class="o">=</span>.:<span class="nv">$PYTHONPATH</span> python <span class="nv">$MELANGE_DIR</span>/bin/melange-manage --config-file<span class="o">=</span><span class="nv">$MELANGE_CONFIG_FILE</span> db_sync
    screen_it m-svc <span class="s2">&quot;cd $MELANGE_DIR &amp;&amp; PYTHONPATH=.:$PYTHONPATH python $MELANGE_DIR/bin/melange-server --config-file=$MELANGE_CONFIG_FILE&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for melange to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= wget -q -O- http://127.0.0.1:9898; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;melange-server did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">    </span>melange mac_address_range create <span class="nv">cidr</span><span class="o">=</span><span class="nv">$M_MAC_RANGE</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>If we're using Quantum (i.e. q-svc is enabled), network creation has to
happen after we've started the Quantum service.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled mysql <span class="o">&amp;&amp;</span> is_service_enabled nova; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>create a small network</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_DIR</span>/bin/nova-manage network create private <span class="nv">$FIXED_RANGE</span> 1 <span class="nv">$FIXED_NETWORK_SIZE</span>

</pre></div></td></tr><tr><td class=docs>
<p>create some floating ips</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_DIR</span>/bin/nova-manage floating create <span class="nv">$FLOATING_RANGE</span>

</pre></div></td></tr><tr><td class=docs>
<p>create a second pool</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_DIR</span>/bin/nova-manage floating create --ip_range<span class="o">=</span><span class="nv">$TEST_FLOATING_RANGE</span> --pool<span class="o">=</span><span class="nv">$TEST_FLOATING_POOL</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>Launching nova-compute should be as simple as running <tt class="docutils literal"><span class="pre">nova-compute</span></tt> but
have to do a little more than that in our script.  Since we add the group
<tt class="docutils literal">libvirtd</tt> to our user in this script, when nova-compute is run it is
within the context of our original shell (so our groups won't be updated).
Use 'sg' to execute nova-compute as a member of the libvirtd group.
We don't check for is_service_enable as screen_it does it for us</p>
</td><td class=code><div class=highlight><pre>
screen_it n-cpu <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; sg libvirtd $NOVA_DIR/bin/nova-compute&quot;</span>
screen_it n-crt <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-cert&quot;</span>
screen_it n-obj <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-objectstore&quot;</span>
screen_it n-vol <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-volume&quot;</span>
screen_it n-net <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-network&quot;</span>
screen_it n-sch <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-scheduler&quot;</span>
screen_it n-novnc <span class="s2">&quot;cd $NOVNC_DIR &amp;&amp; ./utils/nova-novncproxy --config-file $NOVA_CONF_DIR/$NOVA_CONF --web .&quot;</span>
screen_it n-xvnc <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; ./bin/nova-xvpvncproxy --config-file $NOVA_CONF_DIR/$NOVA_CONF&quot;</span>
screen_it n-cauth <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; ./bin/nova-consoleauth&quot;</span>
screen_it horizon <span class="s2">&quot;cd $HORIZON_DIR &amp;&amp; sudo tail -f /var/log/apache2/error.log&quot;</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="install-images">
<h1>Install Images</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Upload an image to glance.</p>
<p>The default image is a small <strong>*TTY*</strong> testing image, which lets you login
the username/password of root/password.</p>
<p>TTY also uses cloud-init, supporting login via keypair and sending scripts as
userdata.  See <a class="reference external" href="https://help.ubuntu.com/community/CloudInit">https://help.ubuntu.com/community/CloudInit</a> for more on cloud-init</p>
<p>Override <tt class="docutils literal">IMAGE_URLS</tt> with a comma-separated list of uec images.</p>
<blockquote>
<ul class="simple">
<li><strong>natty</strong>: <a class="reference external" href="http://uec-images.ubuntu.com/natty/current/natty-server-cloudimg-amd64.tar.gz">http://uec-images.ubuntu.com/natty/current/natty-server-cloudimg-amd64.tar.gz</a></li>
<li><strong>oneiric</strong>: <a class="reference external" href="http://uec-images.ubuntu.com/oneiric/current/oneiric-server-cloudimg-amd64.tar.gz">http://uec-images.ubuntu.com/oneiric/current/oneiric-server-cloudimg-amd64.tar.gz</a></li>
</ul>
</blockquote>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create a directory for the downloaded image tarballs.</p>
</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$FILES</span>/images

    <span class="nv">ADMIN_USER</span><span class="o">=</span>admin
    <span class="nv">ADMIN_TENANT</span><span class="o">=</span>admin
    <span class="nv">TOKEN</span><span class="o">=</span><span class="sb">`</span>curl -s -d  <span class="s2">&quot;{\&quot;auth\&quot;:{\&quot;passwordCredentials\&quot;: {\&quot;username\&quot;: \&quot;$ADMIN_USER\&quot;, \&quot;password\&quot;: \&quot;$ADMIN_PASSWORD\&quot;}, \&quot;tenantName\&quot;: \&quot;$ADMIN_TENANT\&quot;}}&quot;</span> -H <span class="s2">&quot;Content-type: application/json&quot;</span> http://<span class="nv">$HOST_IP</span>:5000/v2.0/tokens | python -c <span class="s2">&quot;import sys; import json; tok = json.loads(sys.stdin.read()); print tok[&#39;access&#39;][&#39;token&#39;][&#39;id&#39;];&quot;</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Option to upload legacy ami-tty, which works with xenserver</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$UPLOAD_LEGACY_TTY</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[</span> ! -f <span class="nv">$FILES</span>/tty.tgz <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>wget -c http://images.ansolabs.com/tty.tgz -O <span class="nv">$FILES</span>/tty.tgz
        <span class="k">fi</span>

<span class="k">        </span>tar -zxf <span class="nv">$FILES</span>/tty.tgz -C <span class="nv">$FILES</span>/images
        <span class="nv">RVAL</span><span class="o">=</span><span class="sb">`</span>glance add --silent-upload -A <span class="nv">$TOKEN</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;tty-kernel&quot;</span> <span class="nv">is_public</span><span class="o">=</span><span class="nb">true </span><span class="nv">container_format</span><span class="o">=</span>aki <span class="nv">disk_format</span><span class="o">=</span>aki &lt; <span class="nv">$FILES</span>/images/aki-tty/image<span class="sb">`</span>
        <span class="nv">KERNEL_ID</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$RVAL</span> | cut -d<span class="s2">&quot;:&quot;</span> -f2 | tr -d <span class="s2">&quot; &quot;</span><span class="sb">`</span>
        <span class="nv">RVAL</span><span class="o">=</span><span class="sb">`</span>glance add --silent-upload -A <span class="nv">$TOKEN</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;tty-ramdisk&quot;</span> <span class="nv">is_public</span><span class="o">=</span><span class="nb">true </span><span class="nv">container_format</span><span class="o">=</span>ari <span class="nv">disk_format</span><span class="o">=</span>ari &lt; <span class="nv">$FILES</span>/images/ari-tty/image<span class="sb">`</span>
        <span class="nv">RAMDISK_ID</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$RVAL</span> | cut -d<span class="s2">&quot;:&quot;</span> -f2 | tr -d <span class="s2">&quot; &quot;</span><span class="sb">`</span>
        glance add -A <span class="nv">$TOKEN</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;tty&quot;</span> <span class="nv">is_public</span><span class="o">=</span><span class="nb">true </span><span class="nv">container_format</span><span class="o">=</span>ami <span class="nv">disk_format</span><span class="o">=</span>ami <span class="nv">kernel_id</span><span class="o">=</span><span class="nv">$KERNEL_ID</span> <span class="nv">ramdisk_id</span><span class="o">=</span><span class="nv">$RAMDISK_ID</span> &lt; <span class="nv">$FILES</span>/images/ami-tty/image
    <span class="k">fi</span>

<span class="k">    for </span>image_url in <span class="k">${</span><span class="nv">IMAGE_URLS</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
</pre></div></td></tr><tr><td class=docs>
<p>Downloads the image (uec ami+aki style), then extracts it.</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">IMAGE_FNAME</span><span class="o">=</span><span class="sb">`</span>basename <span class="s2">&quot;$image_url&quot;</span><span class="sb">`</span>
        <span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$FILES</span>/<span class="nv">$IMAGE_FNAME</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>wget -c <span class="nv">$image_url</span> -O <span class="nv">$FILES</span>/<span class="nv">$IMAGE_FNAME</span>
        <span class="k">fi</span>

<span class="k">        </span><span class="nv">KERNEL</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nv">RAMDISK</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">case</span> <span class="s2">&quot;$IMAGE_FNAME&quot;</span> in
            *.tar.gz|*.tgz<span class="o">)</span>
</pre></div></td></tr><tr><td class=docs>
<p>Extract ami and aki files</p>
</td><td class=code><div class=highlight><pre>
                <span class="o">[</span> <span class="s2">&quot;${IMAGE_FNAME%.tar.gz}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;$IMAGE_FNAME&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
                    <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="s2">&quot;${IMAGE_FNAME%.tar.gz}&quot;</span> <span class="o">||</span>
                    <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="s2">&quot;${IMAGE_FNAME%.tgz}&quot;</span>
                <span class="nv">xdir</span><span class="o">=</span><span class="s2">&quot;$FILES/images/$IMAGE_NAME&quot;</span>
                rm -Rf <span class="s2">&quot;$xdir&quot;</span>;
                mkdir <span class="s2">&quot;$xdir&quot;</span>
                tar -zxf <span class="nv">$FILES</span>/<span class="nv">$IMAGE_FNAME</span> -C <span class="s2">&quot;$xdir&quot;</span>
                <span class="nv">KERNEL</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*-vmlinuz*; <span class="k">do</span>
                         <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
                <span class="nv">RAMDISK</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*-initrd*; <span class="k">do</span>
                         <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
                <span class="nv">IMAGE</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*.img; <span class="k">do</span>
                         <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
                <span class="o">[</span> -n <span class="s2">&quot;$IMAGE_NAME&quot;</span> <span class="o">]</span>
                <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.img&quot;</span><span class="k">)</span>
                ;;
            *.img<span class="o">)</span>
                <span class="nv">IMAGE</span><span class="o">=</span><span class="s2">&quot;$FILES/$IMAGE_FNAME&quot;</span>;
                <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.img&quot;</span><span class="k">)</span>
                ;;
            *.img.gz<span class="o">)</span>
                <span class="nv">IMAGE</span><span class="o">=</span><span class="s2">&quot;$FILES/${IMAGE_FNAME}&quot;</span>
                <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.img.gz&quot;</span><span class="k">)</span>
                ;;
            *<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;Do not know what to do with $IMAGE_FNAME&quot;</span>; <span class="nb">false</span>;;
        <span class="k">esac</span>

</pre></div></td></tr><tr><td class=docs>
<p>Use glance client to add the kernel the root filesystem.
We parse the results of the first upload to get the glance ID of the
kernel for use when uploading the root filesystem.</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">KERNEL_ID</span><span class="o">=</span><span class="s2">&quot;&quot;</span>; <span class="nv">RAMDISK_ID</span><span class="o">=</span><span class="s2">&quot;&quot;</span>;
        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$KERNEL&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">RVAL</span><span class="o">=</span><span class="sb">`</span>glance add --silent-upload -A <span class="nv">$TOKEN</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;$IMAGE_NAME-kernel&quot;</span> <span class="nv">is_public</span><span class="o">=</span><span class="nb">true </span><span class="nv">container_format</span><span class="o">=</span>aki <span class="nv">disk_format</span><span class="o">=</span>aki &lt; <span class="s2">&quot;$KERNEL&quot;</span><span class="sb">`</span>
            <span class="nv">KERNEL_ID</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$RVAL</span> | cut -d<span class="s2">&quot;:&quot;</span> -f2 | tr -d <span class="s2">&quot; &quot;</span><span class="sb">`</span>
        <span class="k">fi</span>
<span class="k">        if</span> <span class="o">[</span> -n <span class="s2">&quot;$RAMDISK&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">RVAL</span><span class="o">=</span><span class="sb">`</span>glance add --silent-upload -A <span class="nv">$TOKEN</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;$IMAGE_NAME-ramdisk&quot;</span> <span class="nv">is_public</span><span class="o">=</span><span class="nb">true </span><span class="nv">container_format</span><span class="o">=</span>ari <span class="nv">disk_format</span><span class="o">=</span>ari &lt; <span class="s2">&quot;$RAMDISK&quot;</span><span class="sb">`</span>
            <span class="nv">RAMDISK_ID</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$RVAL</span> | cut -d<span class="s2">&quot;:&quot;</span> -f2 | tr -d <span class="s2">&quot; &quot;</span><span class="sb">`</span>
        <span class="k">fi</span>
<span class="k">        </span>glance add -A <span class="nv">$TOKEN</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;${IMAGE_NAME%.img}&quot;</span> <span class="nv">is_public</span><span class="o">=</span><span class="nb">true </span><span class="nv">container_format</span><span class="o">=</span>ami <span class="nv">disk_format</span><span class="o">=</span>ami <span class="k">${</span><span class="nv">KERNEL_ID</span><span class="p">:+kernel_id=</span><span class="nv">$KERNEL_ID</span><span class="k">}</span> <span class="k">${</span><span class="nv">RAMDISK_ID</span><span class="p">:+ramdisk_id=</span><span class="nv">$RAMDISK_ID</span><span class="k">}</span> &lt; &lt;<span class="o">(</span>zcat --force <span class="s2">&quot;${IMAGE}&quot;</span><span class="o">)</span>
    <span class="k">done</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="fin">
<h1>Fin</h1>
</td><td class=code><div class=highlight><pre>

<span class="nb">set</span> +o xtrace

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="using-the-cloud">
<h1>Using the cloud</h1>
</td><td class=code><div class=highlight><pre>

<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>If you installed the horizon on this server, then you should be able
to access the site using your browser.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;horizon is now available at http://$SERVICE_HOST/&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>If keystone is present, you can point nova cli to this server</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;keystone is serving at $KEYSTONE_AUTH_PROTOCOL://$SERVICE_HOST:$KEYSTONE_API_PORT/v2.0/&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;examples on using novaclient command line is in exercise.sh&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;the default users are: admin and demo&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;the password: $ADMIN_PASSWORD&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Echo HOST_IP - useful for build_uec.sh, which uses dhcp to give the instance an address</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">echo</span> <span class="s2">&quot;This is your host ip: $HOST_IP&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Warn that EXTRA_FLAGS needs to be converted to EXTRA_OPTS</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$EXTRA_FLAGS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: EXTRA_FLAGS is defined and may need to be converted to EXTRA_OPTS&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Indicate how long this took to run (bash maintained variable 'SECONDS')</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">echo</span> <span class="s2">&quot;stack.sh completed in $SECONDS seconds.&quot;</span>


</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
