<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>swift</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>swift</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.7: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 6253 2010-03-02 00:24:53Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p>lib/swift
Functions to control the configuration and operation of the swift service
Dependencies:
<tt class="docutils literal">functions</tt> file
<tt class="docutils literal">DEST</tt>, <tt class="docutils literal">SCREEN_NAME</tt>, <cite>SWIFT_HASH</cite> must be defined
<tt class="docutils literal">SWIFT_DATA_DIR</tt> or <tt class="docutils literal">DATA_DIR</tt> must be defined
<tt class="docutils literal">lib/keystone</tt> file
<tt class="docutils literal">stack.sh</tt> calls the entry points in this order:</p>
<p>install_swift
configure_swift
init_swift
start_swift
stop_swift
cleanup_swift</p>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
<p>Save trace setting</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">XTRACE</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
<span class="nb">set</span> +o xtrace


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="defaults">
<h1>Defaults</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>&lt;define global variables here that belong to this project&gt;</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Set up default directories</p>
</td><td class=code><div class=highlight><pre>

<span class="nv">SWIFT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/swift
<span class="nv">SWIFTCLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-swiftclient

</pre></div></td></tr><tr><td class=docs>
<p>TODO: add logging to different location.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Set <tt class="docutils literal">SWIFT_DATA_DIR</tt> to the location of swift drives and objects.
Default is the common DevStack data directory.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_DATA_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">:-${</span><span class="nv">DATA_DIR</span><span class="k">}</span><span class="p">/swift</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set <tt class="docutils literal">SWIFT_CONFIG_DIR</tt> to the location of the configuration files.
Default is <tt class="docutils literal">/etc/swift</tt>.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_CONFIG_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">:-</span><span class="p">/etc/swift</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>DevStack will create a loop-back disk formatted as XFS to store the
swift data. Set <tt class="docutils literal">SWIFT_LOOPBACK_DISK_SIZE</tt> to the disk size in bytes.
Default is 1 gigabyte.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_LOOPBACK_DISK_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_LOOPBACK_DISK_SIZE</span><span class="k">:-</span><span class="nv">1000000</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>The ring uses a configurable number of bits from a pathâ€™s MD5 hash as
a partition index that designates a device. The number of bits kept
from the hash is known as the partition power, and 2 to the partition
power indicates the partition count. Partitioning the full MD5 hash
ring allows other parts of the cluster to work in batches of items at
once which ends up either more efficient or at least less complex than
working with each item separately or the entire cluster all at once.
By default we define 9 for the partition count (which mean 512).</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">:-</span><span class="nv">9</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set <tt class="docutils literal">SWIFT_REPLICAS</tt> to configure how many replicas are to be
configured for your Swift cluster.  By default the three replicas would need a
bit of IO and Memory on a VM you may want to lower that to 1 if you want to do
only some quick testing.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_REPLICAS</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">:-</span><span class="nv">3</span><span class="k">}</span>
<span class="nv">SWIFT_REPLICAS_SEQ</span><span class="o">=</span><span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set <tt class="docutils literal">OBJECT_PORT_BASE</tt>, <tt class="docutils literal">CONTAINER_PORT_BASE</tt>, <tt class="docutils literal">ACCOUNT_PORT_BASE</tt>
Port bases used in port number calclution for the service &quot;nodes&quot;
The specified port number will be used, the additinal ports calculated by
base_port + node_num * 10</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">OBJECT_PORT_BASE</span><span class="o">=</span>6010
<span class="nv">CONTAINER_PORT_BASE</span><span class="o">=</span>6011
<span class="nv">ACCOUNT_PORT_BASE</span><span class="o">=</span>6012

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="entry-points">
<h1>Entry Points</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>cleanup_swift() - Remove residual data files</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>cleanup_swift<span class="o">()</span> <span class="o">{</span>
   rm -f <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span><span class="o">{</span>*.builder,*.ring.gz,backups/*.builder,backups/*.ring.gz<span class="o">}</span>
   <span class="k">if </span>egrep -q <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1 /proc/mounts; <span class="k">then</span>
<span class="k">      </span>sudo umount <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1
   <span class="k">fi</span>
<span class="k">   if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img <span class="o">]]</span>; <span class="k">then</span>
<span class="k">      </span>rm <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img
   <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>configure_swift() - Set config files, create data dirs and loop image</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>configure_swift<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span>swift_auth_server
    <span class="nb">local </span>node_number
    <span class="nb">local </span>swift_node_config
    <span class="nb">local </span>swift_log_dir

    setup_develop <span class="nv">$SWIFT_DIR</span>

</pre></div></td></tr><tr><td class=docs>
<p>Make sure to kill all swift processes first</p>
</td><td class=code><div class=highlight><pre>
    swift-init all stop <span class="o">||</span> <span class="nb">true</span>

</pre></div></td></tr><tr><td class=docs>
<p>First do a bit of setup by creating the directories and
changing the permissions so we can run it as our user.</p>
</td><td class=code><div class=highlight><pre>

    <span class="nv">USER_GROUP</span><span class="o">=</span><span class="k">$(</span>id -g<span class="k">)</span>
    sudo mkdir -p <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives
    sudo chown -R <span class="nv">$USER</span>:<span class="k">${</span><span class="nv">USER_GROUP</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a loopback disk and format it to XFS.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        if </span>egrep -q <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1 /proc/mounts; <span class="k">then</span>
<span class="k">            </span>sudo umount <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1
        <span class="k">fi</span>
<span class="k">    else</span>
<span class="k">        </span>mkdir -p  <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images
        sudo touch  <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img
        sudo chown <span class="nv">$USER</span>: <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img

        dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img <span class="se">\</span>
            <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span>0 <span class="nv">seek</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_LOOPBACK_DISK_SIZE</span><span class="k">}</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Make a fresh XFS filesystem</p>
</td><td class=code><div class=highlight><pre>
    mkfs.xfs -f -i <span class="nv">size</span><span class="o">=</span>1024  <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img

</pre></div></td></tr><tr><td class=docs>
<p>Mount the disk with mount options to make it as efficient as possible</p>
</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1
    <span class="k">if</span> ! egrep -q <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1 /proc/mounts; <span class="k">then</span>
<span class="k">        </span>sudo mount -t xfs -o loop,noatime,nodiratime,nobarrier,logbufs<span class="o">=</span>8  <span class="se">\</span>
            <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a link to the above mount and
create all of the directories needed to emulate a few different servers</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">for </span>node_number in <span class="k">${</span><span class="nv">SWIFT_REPLICAS_SEQ</span><span class="k">}</span>; <span class="k">do</span>
<span class="k">        </span>sudo ln -sf <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1/<span class="nv">$node_number</span> <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/<span class="nv">$node_number</span>;
        <span class="nv">drive</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1/<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>
        <span class="nv">node</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>/node
        <span class="nv">node_device</span><span class="o">=</span><span class="k">${</span><span class="nv">node</span><span class="k">}</span>/sdb1
        <span class="o">[[</span> -d <span class="nv">$node</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
        <span class="o">[[</span> -d <span class="nv">$drive</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
<span class="k">        </span>sudo install -o <span class="k">${</span><span class="nv">USER</span><span class="k">}</span> -g <span class="nv">$USER_GROUP</span> -d <span class="nv">$drive</span>
        sudo install -o <span class="k">${</span><span class="nv">USER</span><span class="k">}</span> -g <span class="nv">$USER_GROUP</span> -d <span class="nv">$node_device</span>
        sudo chown -R <span class="nv">$USER</span>: <span class="k">${</span><span class="nv">node</span><span class="k">}</span>
    <span class="k">done</span>

<span class="k">   </span>sudo mkdir -p <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/<span class="o">{</span>object,container,account<span class="o">}</span>-server /var/run/swift
   sudo chown -R <span class="nv">$USER</span>: <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span> /var/run/swift

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$SWIFT_CONFIG_DIR&quot;</span> !<span class="o">=</span> <span class="s2">&quot;/etc/swift&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Some swift tools are hard-coded to use <tt class="docutils literal">/etc/swift</tt> and are apparently not going to be fixed.
Create a symlink if the config dir is moved</p>
</td><td class=code><div class=highlight><pre>
        sudo ln -sf <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span> /etc/swift
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Swift use rsync to synchronize between all the different
partitions (which make more sense when you have a multi-node
setup) we configure it with our version of rsync.</p>
</td><td class=code><div class=highlight><pre>
    sed -e <span class="s2">&quot;</span>
<span class="s2">        s/%GROUP%/${USER_GROUP}/;</span>
<span class="s2">        s/%USER%/$USER/;</span>
<span class="s2">        s,%SWIFT_DATA_DIR%,$SWIFT_DATA_DIR,;</span>
<span class="s2">    &quot;</span> <span class="nv">$FILES</span>/swift/rsyncd.conf | sudo tee /etc/rsyncd.conf
</pre></div></td></tr><tr><td class=docs>
<p>rsyncd.conf just prepared for 4 nodes</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo sed -i <span class="s1">&#39;/^RSYNC_ENABLE=false/ { s/false/true/ }&#39;</span> /etc/default/rsync
    <span class="k">else</span>
<span class="k">        </span>sudo sed -i <span class="s1">&#39;/disable *= *yes/ { s/yes/no/ }&#39;</span> /etc/xinetd.d/rsync
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled swift3;then
        <span class="nv">swift_auth_server</span><span class="o">=</span><span class="s2">&quot;s3token &quot;</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>By default Swift will be installed with the tempauth middleware
which has some default username and password if you have
configured keystone it will checkout the directory.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">        </span>swift_auth_server+<span class="o">=</span><span class="s2">&quot;authtoken keystoneauth&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">swift_auth_server</span><span class="o">=</span>tempauth
    <span class="k">fi</span>

<span class="k">    </span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/proxy-server.conf
    cp <span class="k">${</span><span class="nv">SWIFT_DIR</span><span class="k">}</span>/etc/proxy-server.conf-sample <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span>

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT user
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT user <span class="k">${</span><span class="nv">USER</span><span class="k">}</span>

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT swift_dir
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT swift_dir <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT workers
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT workers 1

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT log_level
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT log_level DEBUG

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT bind_port
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT bind_port <span class="k">${</span><span class="nv">SWIFT_DEFAULT_BIND_PORT</span><span class="k">:-</span><span class="nv">8080</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Only enable Swift3 if we have it enabled in ENABLED_SERVICES</p>
</td><td class=code><div class=highlight><pre>
    is_service_enabled swift3 <span class="o">&amp;&amp;</span> <span class="nv">swift3</span><span class="o">=</span>swift3 <span class="o">||</span> <span class="nv">swift3</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> pipeline:main pipeline <span class="s2">&quot;catch_errors healthcheck cache ratelimit ${swift3} ${swift_auth_server} proxy-logging proxy-server&quot;</span>

    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> app:proxy-server account_autocreate <span class="nb">true</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure Keystone</p>
</td><td class=code><div class=highlight><pre>
    sed -i <span class="s1">&#39;/^# \[filter:authtoken\]/,/^# \[filter:keystoneauth\]$/ s/^#[ \t]*//&#39;</span> <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span>
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:authtoken auth_host <span class="nv">$KEYSTONE_AUTH_HOST</span>
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:authtoken auth_port <span class="nv">$KEYSTONE_AUTH_PORT</span>
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:authtoken auth_protocol <span class="nv">$KEYSTONE_AUTH_PROTOCOL</span>
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:authtoken auth_uri <span class="nv">$KEYSTONE_SERVICE_PROTOCOL</span>://<span class="nv">$KEYSTONE_SERVICE_HOST</span>:<span class="nv">$KEYSTONE_SERVICE_PORT</span>/
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:authtoken admin_tenant_name <span class="nv">$SERVICE_TENANT_NAME</span>
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:authtoken admin_user swift
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:authtoken admin_password <span class="nv">$SERVICE_PASSWORD</span>

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:keystoneauth use
    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:keystoneauth operator_roles
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:keystoneauth operator_roles <span class="s2">&quot;Member, admin&quot;</span>

    <span class="k">if </span>is_service_enabled swift3; <span class="k">then</span>
<span class="k">        </span>cat <span class="s">&lt;&lt;EOF &gt;&gt;${SWIFT_CONFIG_PROXY_SERVER}</span>
<span class="s"># DIVIDER</span>
<span class="s">[filter:s3token]</span>
<span class="s">paste.filter_factory = keystone.middleware.s3_token:filter_factory</span>
<span class="s">auth_port = ${KEYSTONE_AUTH_PORT}</span>
<span class="s">auth_host = ${KEYSTONE_AUTH_HOST}</span>
<span class="s">auth_protocol = ${KEYSTONE_AUTH_PROTOCOL}</span>
<span class="s">auth_token = ${SERVICE_TOKEN}</span>
<span class="s">admin_token = ${SERVICE_TOKEN}</span>

<span class="s">[filter:swift3]</span>
<span class="s">use = egg:swift3#swift3</span>
<span class="s">EOF</span>
    <span class="k">fi</span>

<span class="k">    </span>cp <span class="k">${</span><span class="nv">SWIFT_DIR</span><span class="k">}</span>/etc/swift.conf-sample <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/swift.conf
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/swift.conf swift-hash swift_hash_path_suffix <span class="k">${</span><span class="nv">SWIFT_HASH</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>NOTE(chmou): s3token middleware is not updated yet to use only
username and password.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">function </span>generate_swift_config<span class="o">()</span> <span class="o">{</span>
        <span class="nb">local </span><span class="nv">swift_node_config</span><span class="o">=</span><span class="nv">$1</span>
        <span class="nb">local </span><span class="nv">node_id</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">local </span><span class="nv">bind_port</span><span class="o">=</span><span class="nv">$3</span>

        <span class="nv">log_facility</span><span class="o">=</span><span class="nv">$[</span> node_id - 1 <span class="o">]</span>
        <span class="nv">node_path</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>

        iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT user
        iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT user <span class="k">${</span><span class="nv">USER</span><span class="k">}</span>

        iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT bind_port
        iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT bind_port <span class="k">${</span><span class="nv">bind_port</span><span class="k">}</span>

        iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT swift_dir
        iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT swift_dir <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>

        iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT devices
        iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT devices <span class="k">${</span><span class="nv">node_path</span><span class="k">}</span>

        iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT log_facility
        iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT log_facility LOG_LOCAL<span class="k">${</span><span class="nv">log_facility</span><span class="k">}</span>

        iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT mount_check
        iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT mount_check <span class="nb">false</span>

<span class="nb">        </span>iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> <span class="k">${</span><span class="nv">server_type</span><span class="k">}</span>-replicator vm_test_mode
        iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> <span class="k">${</span><span class="nv">server_type</span><span class="k">}</span>-replicator vm_test_mode yes
    <span class="o">}</span>

    <span class="k">for </span>node_number in <span class="k">${</span><span class="nv">SWIFT_REPLICAS_SEQ</span><span class="k">}</span>; <span class="k">do</span>
<span class="k">        </span><span class="nv">swift_node_config</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/object-server/<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>.conf
        cp <span class="k">${</span><span class="nv">SWIFT_DIR</span><span class="k">}</span>/etc/object-server.conf-sample <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span>
        generate_swift_config <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> <span class="k">${</span><span class="nv">node_number</span><span class="k">}</span> <span class="nv">$[</span>OBJECT_PORT_BASE + 10 * <span class="o">(</span>node_number - 1<span class="o">)]</span>

        <span class="nv">swift_node_config</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/container-server/<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>.conf
        cp <span class="k">${</span><span class="nv">SWIFT_DIR</span><span class="k">}</span>/etc/container-server.conf-sample <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span>
        generate_swift_config <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> <span class="k">${</span><span class="nv">node_number</span><span class="k">}</span> <span class="nv">$[</span>CONTAINER_PORT_BASE + 10 * <span class="o">(</span>node_number - 1<span class="o">)]</span>

        <span class="nv">swift_node_config</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/account-server/<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>.conf
        cp <span class="k">${</span><span class="nv">SWIFT_DIR</span><span class="k">}</span>/etc/account-server.conf-sample <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span>
        generate_swift_config <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> <span class="k">${</span><span class="nv">node_number</span><span class="k">}</span> <span class="nv">$[</span>ACCOUNT_PORT_BASE + 10 * <span class="o">(</span>node_number - 1<span class="o">)]</span>
    <span class="k">done</span>

<span class="k">    </span><span class="nv">swift_log_dir</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/logs
    rm -rf <span class="k">${</span><span class="nv">swift_log_dir</span><span class="k">}</span>
    mkdir -p <span class="k">${</span><span class="nv">swift_log_dir</span><span class="k">}</span>/hourly
    sudo chown -R <span class="nv">$USER</span>:adm <span class="k">${</span><span class="nv">swift_log_dir</span><span class="k">}</span>
    sed <span class="s2">&quot;s,%SWIFT_LOGDIR%,${swift_log_dir},&quot;</span> <span class="nv">$FILES</span>/swift/rsyslog.conf | sudo <span class="se">\</span>
        tee /etc/rsyslog.d/10-swift.conf

<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>This function generates an object/account/proxy configuration
emulating 4 nodes on different ports</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>configure_swiftclient<span class="o">()</span> <span class="o">{</span>
    setup_develop <span class="nv">$SWIFTCLIENT_DIR</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>configure_swiftclient() - Set config files, create data dirs, etc</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>init_swift<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span>node_number
</pre></div></td></tr><tr><td class=docs>
<p>init_swift() - Initialize rings</p>
</td><td class=code><div class=highlight><pre>
    swift-init all stop <span class="o">||</span> <span class="nb">true</span>

</pre></div></td></tr><tr><td class=docs>
<p>Make sure to kill all swift processes first</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">pushd</span> <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span> &gt;/dev/null <span class="o">&amp;&amp;</span> <span class="o">{</span>

        rm -f *.builder *.ring.gz backups/*.builder backups/*.ring.gz

        swift-ring-builder object.builder create <span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">}</span> 1
        swift-ring-builder container.builder create <span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">}</span> 1
        swift-ring-builder account.builder create <span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">}</span> 1

        <span class="k">for </span>node_number in <span class="k">${</span><span class="nv">SWIFT_REPLICAS_SEQ</span><span class="k">}</span>; <span class="k">do</span>
<span class="k">            </span>swift-ring-builder object.builder add z<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>-127.0.0.1:<span class="nv">$[</span>OBJECT_PORT_BASE + 10 * <span class="o">(</span>node_number - 1<span class="o">)]</span>/sdb1 1
            swift-ring-builder container.builder add z<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>-127.0.0.1:<span class="nv">$[</span>CONTAINER_PORT_BASE + 10 * <span class="o">(</span>node_number - 1<span class="o">)]</span>/sdb1 1
            swift-ring-builder account.builder add z<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>-127.0.0.1:<span class="nv">$[</span>ACCOUNT_PORT_BASE + 10 * <span class="o">(</span>node_number - 1<span class="o">)]</span>/sdb1 1
        <span class="k">done</span>
<span class="k">        </span>swift-ring-builder object.builder rebalance
        swift-ring-builder container.builder rebalance
        swift-ring-builder account.builder rebalance
    <span class="o">}</span> <span class="o">&amp;&amp;</span> <span class="nb">popd</span> &gt;/dev/null

<span class="o">}</span>

<span class="k">function </span>install_swift<span class="o">()</span> <span class="o">{</span>
    git_clone <span class="nv">$SWIFT_REPO</span> <span class="nv">$SWIFT_DIR</span> <span class="nv">$SWIFT_BRANCH</span>
<span class="o">}</span>

<span class="k">function </span>install_swiftclient<span class="o">()</span> <span class="o">{</span>
    git_clone <span class="nv">$SWIFTCLIENT_REPO</span> <span class="nv">$SWIFTCLIENT_DIR</span> <span class="nv">$SWIFTCLIENT_BRANCH</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>This is where we create three different rings for swift with
different object servers binding on different ports.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>start_swift<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>start_swift() - Start running processes, including screen</p>
</td><td class=code><div class=highlight><pre>
    restart_service rsyslog
</pre></div></td></tr><tr><td class=docs>
<p>(re)start rsyslog</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo /etc/init.d/rsync restart <span class="o">||</span> :
    <span class="k">else</span>
<span class="k">        </span>sudo systemctl start xinetd.service
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Start rsync</p>
</td><td class=code><div class=highlight><pre>
   swift-init all restart <span class="o">||</span> <span class="nb">true</span>
<span class="nb">   </span>swift-init proxy stop <span class="o">||</span> <span class="nb">true</span>
<span class="nb">   </span>screen_it swift <span class="s2">&quot;cd $SWIFT_DIR &amp;&amp; $SWIFT_DIR/bin/swift-proxy-server ${SWIFT_CONFIG_DIR}/proxy-server.conf -v&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>First spawn all the swift services then kill the
proxy service so we can run it in foreground in screen.
<tt class="docutils literal"><span class="pre">swift-init</span> ... {stop|restart}</tt> exits with '1' if no servers are running,
ignore it just in case</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>stop_swift<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>stop_swift() - Stop running processes (non-screen)</p>
</td><td class=code><div class=highlight><pre>
    swift-init all stop <span class="o">||</span> <span class="nb">true</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>screen normally killed by unstack.sh</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">$XTRACE</span>


</pre></div></td></tr><tr><td class=docs>
<p>Restore xtrace</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</pre></div></td></tr><tr><td class=docs>
</div>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
