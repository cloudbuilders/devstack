<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>nova</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>nova</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.11: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p>lib/nova
Functions to control the configuration and operation of the <strong>Nova</strong> service
Dependencies:
<tt class="docutils literal">functions</tt> file
<tt class="docutils literal">DEST</tt>, <tt class="docutils literal">DATA_DIR</tt>, <tt class="docutils literal">STACK_USER</tt> must be defined
<tt class="docutils literal">SERVICE_{TENANT_NAME|PASSWORD}</tt> must be defined
<tt class="docutils literal">LIBVIRT_TYPE</tt> must be defined
<tt class="docutils literal">INSTANCE_NAME_PREFIX</tt>, <tt class="docutils literal">VOLUME_NAME_PREFIX</tt> must be defined
<tt class="docutils literal">KEYSTONE_TOKEN_FORMAT</tt> must be defined</p>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">stack.sh</tt> calls the entry points in this order:</p>
<p>install_nova
configure_nova
create_nova_conf
init_nova
start_nova
stop_nova
cleanup_nova</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Save trace setting</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">XTRACE</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
<span class="nb">set</span> +o xtrace


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="defaults">
<h1>Defaults</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Set up default directories</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">NOVA_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/nova
<span class="nv">NOVACLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-novaclient
<span class="nv">NOVA_STATE_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVA_STATE_PATH</span><span class="p">:=</span><span class="nv">$DATA_DIR</span><span class="p">/nova</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>INSTANCES_PATH is the previous name for this</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">NOVA_INSTANCES_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVA_INSTANCES_PATH</span><span class="p">:=</span><span class="k">${</span><span class="nv">INSTANCES_PATH</span><span class="p">:=</span><span class="nv">$NOVA_STATE_PATH</span><span class="p">/instances</span><span class="k">}}</span>
<span class="nv">NOVA_AUTH_CACHE_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVA_AUTH_CACHE_DIR</span><span class="k">:-</span><span class="p">/var/cache/nova</span><span class="k">}</span>

<span class="nv">NOVA_CONF_DIR</span><span class="o">=</span>/etc/nova
<span class="nv">NOVA_CONF</span><span class="o">=</span><span class="nv">$NOVA_CONF_DIR</span>/nova.conf
<span class="nv">NOVA_CELLS_CONF</span><span class="o">=</span><span class="nv">$NOVA_CONF_DIR</span>/nova-cells.conf
<span class="nv">NOVA_CELLS_DB</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVA_CELLS_DB</span><span class="k">:-</span><span class="nv">nova_cell</span><span class="k">}</span>

<span class="nv">NOVA_API_PASTE_INI</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVA_API_PASTE_INI</span><span class="k">:-</span><span class="nv">$NOVA_CONF_DIR</span><span class="p">/api-paste.ini</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Public facing bits</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">NOVA_SERVICE_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVA_SERVICE_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
<span class="nv">NOVA_SERVICE_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVA_SERVICE_PORT</span><span class="k">:-</span><span class="nv">8774</span><span class="k">}</span>
<span class="nv">NOVA_SERVICE_PORT_INT</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVA_SERVICE_PORT_INT</span><span class="k">:-</span><span class="nv">18774</span><span class="k">}</span>
<span class="nv">NOVA_SERVICE_PROTOCOL</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVA_SERVICE_PROTOCOL</span><span class="k">:-</span><span class="nv">$SERVICE_PROTOCOL</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Support entry points installation of console scripts</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$NOVA_DIR</span>/bin <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">NOVA_BIN_DIR</span><span class="o">=</span><span class="nv">$NOVA_DIR</span>/bin
<span class="k">else</span>
<span class="k">    </span><span class="nv">NOVA_BIN_DIR</span><span class="o">=</span><span class="k">$(</span>get_python_exec_prefix<span class="k">)</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set the paths of certain binaries</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">NOVA_ROOTWRAP</span><span class="o">=</span><span class="k">$(</span>get_rootwrap_location nova<span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>Allow rate limiting to be turned off for testing, like for Tempest
NOTE: Set API_RATE_LIMIT=&quot;False&quot; to turn OFF rate limiting</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">API_RATE_LIMIT</span><span class="o">=</span><span class="k">${</span><span class="nv">API_RATE_LIMIT</span><span class="k">:-</span><span class="s2">&quot;True&quot;</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Nova supports pluggable schedulers.  The default <tt class="docutils literal">FilterScheduler</tt>
should work in most cases.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SCHEDULER</span><span class="o">=</span><span class="k">${</span><span class="nv">SCHEDULER</span><span class="k">:-</span><span class="nv">nova</span><span class="p">.scheduler.filter_scheduler.FilterScheduler</span><span class="k">}</span>

<span class="nv">QEMU_CONF</span><span class="o">=</span>/etc/libvirt/qemu.conf

<span class="nv">NOVNC_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/noVNC
<span class="nv">SPICE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/spice-html5


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="nova-network-configuration">
<h1>Nova Network Configuration</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Set defaults according to the virt driver</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">PUBLIC_INTERFACE_DEFAULT</span><span class="o">=</span>eth2
    <span class="nv">GUEST_INTERFACE_DEFAULT</span><span class="o">=</span>eth1
</pre></div></td></tr><tr><td class=docs>
<p>Allow <tt class="docutils literal">build_domU.sh</tt> to specify the flat network bridge via kernel args</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="o">=</span><span class="k">$(</span>sed -e <span class="s1">&#39;s/.* flat_network_bridge=\([[:alnum:]]*\).*$/\1/g&#39;</span> /proc/cmdline<span class="k">)</span>
    <span class="k">if </span>is_service_enabled neutron; <span class="k">then</span>
<span class="k">        </span><span class="nv">XEN_INTEGRATION_BRIDGE</span><span class="o">=</span><span class="k">$(</span>sed -e <span class="s1">&#39;s/.* xen_integration_bridge=\([[:alnum:]]*\).*$/\1/g&#39;</span> /proc/cmdline<span class="k">)</span>
    <span class="k">fi</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;baremetal&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">NETWORK_MANAGER</span><span class="o">=</span><span class="k">${</span><span class="nv">NETWORK_MANAGER</span><span class="k">:-</span><span class="nv">FlatManager</span><span class="k">}</span>
    <span class="nv">PUBLIC_INTERFACE_DEFAULT</span><span class="o">=</span>eth0
    <span class="nv">FLAT_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_INTERFACE</span><span class="k">:-</span><span class="nv">eth0</span><span class="k">}</span>
    <span class="nv">FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="o">=</span>br100
    <span class="nv">STUB_NETWORK</span><span class="o">=</span><span class="k">${</span><span class="nv">STUB_NETWORK</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>
<span class="k">else</span>
<span class="k">    </span><span class="nv">PUBLIC_INTERFACE_DEFAULT</span><span class="o">=</span>br100
    <span class="nv">GUEST_INTERFACE_DEFAULT</span><span class="o">=</span>eth0
    <span class="nv">FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="o">=</span>br100
<span class="k">fi</span>

<span class="nv">NETWORK_MANAGER</span><span class="o">=</span><span class="k">${</span><span class="nv">NETWORK_MANAGER</span><span class="k">:-${</span><span class="nv">NET_MAN</span><span class="k">:-</span><span class="nv">FlatDHCPManager</span><span class="k">}}</span>
<span class="nv">PUBLIC_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">PUBLIC_INTERFACE</span><span class="k">:-</span><span class="nv">$PUBLIC_INTERFACE_DEFAULT</span><span class="k">}</span>
<span class="nv">VLAN_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">VLAN_INTERFACE</span><span class="k">:-</span><span class="nv">$GUEST_INTERFACE_DEFAULT</span><span class="k">}</span>
<span class="nv">FLAT_NETWORK_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_NETWORK_BRIDGE</span><span class="k">:-</span><span class="nv">$FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="k">}</span>
<span class="nv">EC2_DMZ_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">EC2_DMZ_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>If you are using the FlatDHCP network mode on multiple hosts, set the
<tt class="docutils literal">FLAT_INTERFACE</tt> variable but make sure that the interface doesn't already
have an IP or you risk breaking things.</p>
<p><strong>DHCP Warning</strong>:  If your flat interface device uses DHCP, there will be a
hiccup while the network is moved from the flat interface to the flat network
bridge.  This will happen when you launch your first instance.  Upon launch
you will lose all connectivity to the node, and the VM launch will probably
fail.</p>
<p>If you are running on a single node and don't need to access the VMs from
devices other than that node, you can set <tt class="docutils literal">FLAT_INTERFACE=</tt>
This will stop nova from bridging any interfaces into <tt class="docutils literal">FLAT_NETWORK_BRIDGE</tt>.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">FLAT_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_INTERFACE</span><span class="k">:-</span><span class="nv">$GUEST_INTERFACE_DEFAULT</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">MULTI_HOST</tt> is a mode where each compute node runs its own network node.  This
allows network operations and routing for a VM to occur on the server that is
running the VM - removing a SPOF and bandwidth bottleneck.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">MULTI_HOST</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$MULTI_HOST</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Test floating pool and range are used for testing.  They are defined
here until the admin APIs can replace nova-manage</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TEST_FLOATING_POOL</span><span class="o">=</span><span class="k">${</span><span class="nv">TEST_FLOATING_POOL</span><span class="k">:-</span><span class="nv">test</span><span class="k">}</span>
<span class="nv">TEST_FLOATING_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">TEST_FLOATING_RANGE</span><span class="k">:-</span><span class="nv">192</span><span class="p">.168.253.0/29</span><span class="k">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="functions">
<h1>Functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Helper to clean iptables rules</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>clean_iptables<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Delete rules</p>
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> | grep <span class="s2">&quot;\-A&quot;</span> |  sed <span class="s2">&quot;s/-A/-D/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables&quot;,$0}&#39;</span> | bash
</pre></div></td></tr><tr><td class=docs>
<p>Delete nat rules</p>
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v -t nat | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> |  grep <span class="s2">&quot;\-A&quot;</span> | sed <span class="s2">&quot;s/-A/-D/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables -t nat&quot;,$0}&#39;</span> | bash
</pre></div></td></tr><tr><td class=docs>
<p>Delete chains</p>
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> | grep <span class="s2">&quot;\-N&quot;</span> |  sed <span class="s2">&quot;s/-N/-X/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables&quot;,$0}&#39;</span> | bash
</pre></div></td></tr><tr><td class=docs>
<p>Delete nat chains</p>
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v -t nat | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> |  grep <span class="s2">&quot;\-N&quot;</span> | sed <span class="s2">&quot;s/-N/-X/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables -t nat&quot;,$0}&#39;</span> | bash
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>cleanup_nova() - Remove residual data files, anything left over from previous
runs that a clean run would need to clean up</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>cleanup_nova<span class="o">()</span> <span class="o">{</span>
    <span class="k">if </span>is_service_enabled n-cpu; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Clean iptables from previous runs</p>
</td><td class=code><div class=highlight><pre>
        clean_iptables

</pre></div></td></tr><tr><td class=docs>
<p>Destroy old instances</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">instances</span><span class="o">=</span><span class="sb">`</span>sudo virsh list --all | grep <span class="nv">$INSTANCE_NAME_PREFIX</span> | sed <span class="s2">&quot;s/.*\($INSTANCE_NAME_PREFIX[0-9a-fA-F]*\).*/\1/g&quot;</span><span class="sb">`</span>
        <span class="k">if</span> <span class="o">[</span> ! <span class="s2">&quot;$instances&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="nv">$instances</span> | xargs -n1 sudo virsh destroy <span class="o">||</span> <span class="nb">true</span>
<span class="nb">            echo</span> <span class="nv">$instances</span> | xargs -n1 sudo virsh undefine --managed-save <span class="o">||</span> <span class="nb">true</span>
<span class="nb">        </span><span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Logout and delete iscsi sessions</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">tgts</span><span class="o">=</span><span class="k">$(</span>sudo iscsiadm --mode node | grep <span class="nv">$VOLUME_NAME_PREFIX</span> | cut -d <span class="s1">&#39; &#39;</span> -f2<span class="k">)</span>
        <span class="k">for </span>target in <span class="nv">$tgts</span>; <span class="k">do</span>
<span class="k">            </span>sudo iscsiadm --mode node -T <span class="nv">$target</span> --logout <span class="o">||</span> <span class="nb">true</span>
<span class="nb">        </span><span class="k">done</span>
<span class="k">        </span>sudo iscsiadm --mode node --op delete <span class="o">||</span> <span class="nb">true</span>

</pre></div></td></tr><tr><td class=docs>
<p>Clean out the instances directory.</p>
</td><td class=code><div class=highlight><pre>
        sudo rm -rf <span class="nv">$NOVA_INSTANCES_PATH</span>/*
    <span class="k">fi</span>

<span class="k">    </span>sudo rm -rf <span class="nv">$NOVA_STATE_PATH</span> <span class="nv">$NOVA_AUTH_CACHE_DIR</span>

</pre></div></td></tr><tr><td class=docs>
<dl class="docutils">
<dt>NOTE(dtroyer): This really should be called from here but due to the way</dt>
<dd>nova abuses the _cleanup() function we're moving it
directly into cleanup.sh until this can be fixed.</dd>
</dl>
</td><td class=code><div class=highlight><pre>
    <span class="c">#if is_service_enabled n-cpu &amp;&amp; [[ -r $NOVA_PLUGINS/hypervisor-$VIRT_DRIVER ]]; then</span>
</pre></div></td></tr><tr><td class=docs>
<blockquote>
cleanup_nova_hypervisor</blockquote>
</td><td class=code><div class=highlight><pre>
    <span class="c">#fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>configure_nova_rootwrap() - configure Nova's rootwrap</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>configure_nova_rootwrap<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Deploy new rootwrap filters files (owned by root).
Wipe any existing rootwrap.d files first</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo rm -rf <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Deploy filters to /etc/nova/rootwrap.d</p>
</td><td class=code><div class=highlight><pre>
    sudo mkdir -m 755 <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d
    sudo cp <span class="nv">$NOVA_DIR</span>/etc/nova/rootwrap.d/*.filters <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d
    sudo chown -R root:root <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d
    sudo chmod 644 <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d/*
</pre></div></td></tr><tr><td class=docs>
<p>Set up rootwrap.conf, pointing to /etc/nova/rootwrap.d</p>
</td><td class=code><div class=highlight><pre>
    sudo cp <span class="nv">$NOVA_DIR</span>/etc/nova/rootwrap.conf <span class="nv">$NOVA_CONF_DIR</span>/
    sudo sed -e <span class="s2">&quot;s:^filters_path=.*$:filters_path=$NOVA_CONF_DIR/rootwrap.d:&quot;</span> -i <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.conf
    sudo chown root:root <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.conf
    sudo chmod 0644 <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.conf
</pre></div></td></tr><tr><td class=docs>
<p>Specify rootwrap.conf as first parameter to nova-rootwrap</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">ROOTWRAP_SUDOER_CMD</span><span class="o">=</span><span class="s2">&quot;$NOVA_ROOTWRAP $NOVA_CONF_DIR/rootwrap.conf *&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up the rootwrap sudoers for nova</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">TEMPFILE</span><span class="o">=</span><span class="sb">`</span>mktemp<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;$USER ALL=(root) NOPASSWD: $ROOTWRAP_SUDOER_CMD&quot;</span> &gt;<span class="nv">$TEMPFILE</span>
    chmod 0440 <span class="nv">$TEMPFILE</span>
    sudo chown root:root <span class="nv">$TEMPFILE</span>
    sudo mv <span class="nv">$TEMPFILE</span> /etc/sudoers.d/nova-rootwrap
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>configure_nova() - Set config files, create data dirs, etc</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>configure_nova<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Put config files in <tt class="docutils literal">/etc/nova</tt> for everyone to find</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$NOVA_CONF_DIR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo mkdir -p <span class="nv">$NOVA_CONF_DIR</span>
    <span class="k">fi</span>
<span class="k">    </span>sudo chown <span class="nv">$STACK_USER</span> <span class="nv">$NOVA_CONF_DIR</span>

    cp -p <span class="nv">$NOVA_DIR</span>/etc/nova/policy.json <span class="nv">$NOVA_CONF_DIR</span>

    configure_nova_rootwrap

    <span class="k">if </span>is_service_enabled n-api; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Use the sample http middleware configuration supplied in the
Nova sources.  This paste config adds the configuration required
for Nova to validate Keystone tokens.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Remove legacy paste config if present</p>
</td><td class=code><div class=highlight><pre>
        rm -f <span class="nv">$NOVA_DIR</span>/bin/nova-api-paste.ini

</pre></div></td></tr><tr><td class=docs>
<p>Get the sample configuration file in place</p>
</td><td class=code><div class=highlight><pre>
        cp <span class="nv">$NOVA_DIR</span>/etc/nova/api-paste.ini <span class="nv">$NOVA_CONF_DIR</span>

        iniset <span class="nv">$NOVA_API_PASTE_INI</span> filter:authtoken auth_host <span class="nv">$KEYSTONE_AUTH_HOST</span>
        <span class="k">if </span>is_service_enabled tls-proxy; <span class="k">then</span>
<span class="k">            </span>iniset <span class="nv">$NOVA_API_PASTE_INI</span> filter:authtoken auth_protocol <span class="nv">$KEYSTONE_AUTH_PROTOCOL</span>
        <span class="k">fi</span>
<span class="k">        </span>iniset <span class="nv">$NOVA_API_PASTE_INI</span> filter:authtoken admin_tenant_name <span class="nv">$SERVICE_TENANT_NAME</span>
        iniset <span class="nv">$NOVA_API_PASTE_INI</span> filter:authtoken admin_user nova
        iniset <span class="nv">$NOVA_API_PASTE_INI</span> filter:authtoken admin_password <span class="nv">$SERVICE_PASSWORD</span>
    <span class="k">fi</span>

<span class="k">    </span>iniset <span class="nv">$NOVA_API_PASTE_INI</span> filter:authtoken signing_dir <span class="nv">$NOVA_AUTH_CACHE_DIR</span>

    <span class="k">if </span>is_service_enabled n-cpu; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Force IP forwarding on, just on case</p>
</td><td class=code><div class=highlight><pre>
        sudo sysctl -w net.ipv4.ip_forward<span class="o">=</span>1

        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;libvirt&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Attempt to load modules: network block device - used to manage qcow images</p>
</td><td class=code><div class=highlight><pre>
            sudo modprobe nbd <span class="o">||</span> <span class="nb">true</span>

</pre></div></td></tr><tr><td class=docs>
<p>Check for kvm (hardware based virtualization).  If unable to initialize
kvm, we drop back to the slower emulation mode (qemu).  Note: many systems
come with hardware virtualization disabled in BIOS.</p>
</td><td class=code><div class=highlight><pre>
            <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;kvm&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span>sudo modprobe kvm <span class="o">||</span> <span class="nb">true</span>
<span class="nb">                </span><span class="k">if</span> <span class="o">[</span> ! -e /dev/kvm <span class="o">]</span>; <span class="k">then</span>
<span class="k">                    </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: Switching to QEMU&quot;</span>
                    <span class="nv">LIBVIRT_TYPE</span><span class="o">=</span>qemu
                    <span class="k">if </span>which selinuxenabled 2&gt;&amp;1 &gt; /dev/null <span class="o">&amp;&amp;</span> selinuxenabled; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p><a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=753589">https://bugzilla.redhat.com/show_bug.cgi?id=753589</a></p>
</td><td class=code><div class=highlight><pre>
                        sudo setsebool virt_use_execmem on
                    <span class="k">fi</span>
<span class="k">                fi</span>
<span class="k">            fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install and configure <strong>LXC</strong> if specified.  LXC is another approach to
splitting a system into many smaller parts.  LXC uses cgroups and chroot
to simulate multiple systems.</p>
</td><td class=code><div class=highlight><pre>
            <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;lxc&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                if </span>is_ubuntu; <span class="k">then</span>
<span class="k">                    if</span> <span class="o">[[</span> ! <span class="s2">&quot;$DISTRO&quot;</span> &gt; natty <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                        </span><span class="nv">cgline</span><span class="o">=</span><span class="s2">&quot;none /cgroup cgroup cpuacct,memory,devices,cpu,freezer,blkio 0 0&quot;</span>
                        sudo mkdir -p /cgroup
                        <span class="k">if</span> ! grep -q cgroup /etc/fstab; <span class="k">then</span>
<span class="k">                            </span><span class="nb">echo</span> <span class="s2">&quot;$cgline&quot;</span> | sudo tee -a /etc/fstab
                        <span class="k">fi</span>
<span class="k">                        if</span> ! mount -n | grep -q cgroup; <span class="k">then</span>
<span class="k">                            </span>sudo mount /cgroup
                        <span class="k">fi</span>
<span class="k">                    fi</span>
<span class="k">                fi</span>
<span class="k">            fi</span>
<span class="k">        fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Prepare directories and packages for baremetal driver</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if </span>is_baremetal; <span class="k">then</span>
<span class="k">            </span>configure_baremetal_nova_dirs
        <span class="k">fi</span>

<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;libvirt&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if </span>is_service_enabled neutron <span class="o">&amp;&amp;</span> is_neutron_ovs_base_plugin <span class="o">&amp;&amp;</span> ! sudo grep -q <span class="s1">&#39;^cgroup_device_acl&#39;</span> <span class="nv">$QEMU_CONF</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Add /dev/net/tun to cgroup_device_acls, needed for type=ethernet interfaces</p>
</td><td class=code><div class=highlight><pre>
                cat <span class="s">&lt;&lt;EOF | sudo tee -a $QEMU_CONF</span>
<span class="s">cgroup_device_acl = [</span>
<span class="s">    &quot;/dev/null&quot;, &quot;/dev/full&quot;, &quot;/dev/zero&quot;,</span>
<span class="s">    &quot;/dev/random&quot;, &quot;/dev/urandom&quot;,</span>
<span class="s">    &quot;/dev/ptmx&quot;, &quot;/dev/kvm&quot;, &quot;/dev/kqemu&quot;,</span>
<span class="s">    &quot;/dev/rtc&quot;, &quot;/dev/hpet&quot;,&quot;/dev/net/tun&quot;,</span>
<span class="s">]</span>
<span class="s">EOF</span>
            <span class="k">fi</span>

<span class="k">            if </span>is_ubuntu; <span class="k">then</span>
<span class="k">                </span><span class="nv">LIBVIRT_DAEMON</span><span class="o">=</span>libvirt-bin
            <span class="k">else</span>
<span class="k">                </span><span class="nv">LIBVIRT_DAEMON</span><span class="o">=</span>libvirtd
            <span class="k">fi</span>

<span class="k">            if </span>is_fedora <span class="o">||</span> is_suse; <span class="k">then</span>
<span class="k">                if </span>is_fedora <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="nv">$DISTRO</span> <span class="o">=</span>~ <span class="o">(</span>rhel6<span class="o">)</span> <span class="o">||</span> <span class="s2">&quot;$os_RELEASE&quot;</span> -le <span class="s2">&quot;17&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                    </span>sudo bash -c <span class="s2">&quot;cat &lt;&lt;EOF &gt;/etc/polkit-1/localauthority/50-local.d/50-libvirt-remote-access.pkla</span>
<span class="s2">[libvirt Management Access]</span>
<span class="s2">Identity=unix-group:$LIBVIRT_GROUP</span>
<span class="s2">Action=org.libvirt.unix.manage</span>
<span class="s2">ResultAny=yes</span>
<span class="s2">ResultInactive=yes</span>
<span class="s2">ResultActive=yes</span>
<span class="s2">EOF&quot;</span>
                <span class="k">elif </span>is_suse <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="nv">$os_RELEASE</span> <span class="o">=</span> 12.2 <span class="o">||</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span> <span class="s2">&quot;SUSE LINUX&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>openSUSE &lt; 12.3 or SLE
Work around the fact that polkit-default-privs overrules pklas
with 'unix-group:$group'.</p>
</td><td class=code><div class=highlight><pre>
                    sudo bash -c <span class="s2">&quot;cat &lt;&lt;EOF &gt;/etc/polkit-1/localauthority/50-local.d/50-libvirt-remote-access.pkla</span>
<span class="s2">[libvirt Management Access]</span>
<span class="s2">Identity=unix-user:$USER</span>
<span class="s2">Action=org.libvirt.unix.manage</span>
<span class="s2">ResultAny=yes</span>
<span class="s2">ResultInactive=yes</span>
<span class="s2">ResultActive=yes</span>
<span class="s2">EOF&quot;</span>
                <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Starting with fedora 18 and opensuse-12.3 enable stack-user to
virsh -c qemu:///system by creating a policy-kit rule for
stack-user using the new Javascript syntax</p>
</td><td class=code><div class=highlight><pre>
                    <span class="nv">rules_dir</span><span class="o">=</span>/etc/polkit-1/rules.d
                    sudo mkdir -p <span class="nv">$rules_dir</span>
                    sudo bash -c <span class="s2">&quot;cat &lt;&lt;EOF &gt; $rules_dir/50-libvirt-$STACK_USER.rules</span>
<span class="s2">polkit.addRule(function(action, subject) {</span>
<span class="s2">     if (action.id == &#39;org.libvirt.unix.manage&#39; &amp;&amp;</span>
<span class="s2">         subject.user == &#39;&quot;</span><span class="nv">$STACK_USER</span><span class="s2">&quot;&#39;) {</span>
<span class="s2">         return polkit.Result.YES;</span>
<span class="s2">     }</span>
<span class="s2">});</span>
<span class="s2">EOF&quot;</span>
                    <span class="nb">unset </span>rules_dir
                <span class="k">fi</span>
<span class="k">            fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>The user that nova runs as needs to be member of <strong>libvirtd</strong> group otherwise
nova-compute will be unable to use libvirt.</p>
</td><td class=code><div class=highlight><pre>
            <span class="k">if</span> ! getent group <span class="nv">$LIBVIRT_GROUP</span> &gt;/dev/null; <span class="k">then</span>
<span class="k">                </span>sudo groupadd <span class="nv">$LIBVIRT_GROUP</span>
            <span class="k">fi</span>
<span class="k">            </span>add_user_to_group <span class="nv">$STACK_USER</span> <span class="nv">$LIBVIRT_GROUP</span>

</pre></div></td></tr><tr><td class=docs>
<p>libvirt detects various settings on startup, as we potentially changed
the system configuration (modules, filesystems), we need to restart
libvirt to detect those changes.</p>
</td><td class=code><div class=highlight><pre>
            restart_service <span class="nv">$LIBVIRT_DAEMON</span>
        <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="instance-storage">
<h1>Instance Storage</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Nova stores each instance in its own directory.</p>
</td><td class=code><div class=highlight><pre>
        sudo mkdir -p <span class="nv">$NOVA_INSTANCES_PATH</span>
        sudo chown -R <span class="nv">$STACK_USER</span> <span class="nv">$NOVA_INSTANCES_PATH</span>

</pre></div></td></tr><tr><td class=docs>
<p>You can specify a different disk to be mounted and used for backing the
virtual machines.  If there is a partition labeled nova-instances we
mount it (ext filesystems can be labeled via e2label).</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[</span> -L /dev/disk/by-label/nova-instances <span class="o">]</span>; <span class="k">then</span>
<span class="k">            if</span> ! mount -n | grep -q <span class="nv">$NOVA_INSTANCES_PATH</span>; <span class="k">then</span>
<span class="k">                </span>sudo mount -L nova-instances <span class="nv">$NOVA_INSTANCES_PATH</span>
                sudo chown -R <span class="nv">$STACK_USER</span> <span class="nv">$NOVA_INSTANCES_PATH</span>
            <span class="k">fi</span>
<span class="k">        fi</span>
<span class="k">    fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>create_nova_accounts() - Set up common required nova accounts</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="tenant-user-roles">
<h1>Tenant               User       Roles</h1>
<p>service              nova       admin, [ResellerAdmin (swift only)]</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Migrated from keystone_data.sh</p>
</td><td class=code><div class=highlight><pre>
create_nova_accounts<span class="o">()</span> <span class="o">{</span>

    <span class="nv">SERVICE_TENANT</span><span class="o">=</span><span class="k">$(</span>keystone tenant-list | awk <span class="s2">&quot;/ $SERVICE_TENANT_NAME / { print \$2 }&quot;</span><span class="k">)</span>
    <span class="nv">ADMIN_ROLE</span><span class="o">=</span><span class="k">$(</span>keystone role-list | awk <span class="s2">&quot;/ admin / { print \$2 }&quot;</span><span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>Nova</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;n-api&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">NOVA_USER</span><span class="o">=</span><span class="k">$(</span>keystone user-create <span class="se">\</span>
            --name<span class="o">=</span>nova <span class="se">\</span>
            --pass<span class="o">=</span><span class="s2">&quot;$SERVICE_PASSWORD&quot;</span> <span class="se">\</span>
            --tenant_id <span class="nv">$SERVICE_TENANT</span> <span class="se">\</span>
            --email<span class="o">=</span>nova@example.com <span class="se">\</span>
            | grep <span class="s2">&quot; id &quot;</span> | get_field 2<span class="k">)</span>
        keystone user-role-add <span class="se">\</span>
            --tenant-id <span class="nv">$SERVICE_TENANT</span> <span class="se">\</span>
            --user-id <span class="nv">$NOVA_USER</span> <span class="se">\</span>
            --role-id <span class="nv">$ADMIN_ROLE</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$KEYSTONE_CATALOG_BACKEND&quot;</span> <span class="o">=</span> <span class="s1">&#39;sql&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">NOVA_SERVICE</span><span class="o">=</span><span class="k">$(</span>keystone service-create <span class="se">\</span>
                --name<span class="o">=</span>nova <span class="se">\</span>
                --type<span class="o">=</span>compute <span class="se">\</span>
                --description<span class="o">=</span><span class="s2">&quot;Nova Compute Service&quot;</span> <span class="se">\</span>
                | grep <span class="s2">&quot; id &quot;</span> | get_field 2<span class="k">)</span>
            keystone endpoint-create <span class="se">\</span>
                --region RegionOne <span class="se">\</span>
                --service_id <span class="nv">$NOVA_SERVICE</span> <span class="se">\</span>
                --publicurl <span class="s2">&quot;$NOVA_SERVICE_PROTOCOL://$NOVA_SERVICE_HOST:$NOVA_SERVICE_PORT/v2/\$(tenant_id)s&quot;</span> <span class="se">\</span>
                --adminurl <span class="s2">&quot;$NOVA_SERVICE_PROTOCOL://$NOVA_SERVICE_HOST:$NOVA_SERVICE_PORT/v2/\$(tenant_id)s&quot;</span> <span class="se">\</span>
                --internalurl <span class="s2">&quot;$NOVA_SERVICE_PROTOCOL://$NOVA_SERVICE_HOST:$NOVA_SERVICE_PORT/v2/\$(tenant_id)s&quot;</span>
            <span class="nv">NOVA_V3_SERVICE</span><span class="o">=</span><span class="k">$(</span>keystone service-create <span class="se">\</span>
                --name<span class="o">=</span>nova <span class="se">\</span>
                --type<span class="o">=</span>computev3 <span class="se">\</span>
                --description<span class="o">=</span><span class="s2">&quot;Nova Compute Service V3&quot;</span> <span class="se">\</span>
                | grep <span class="s2">&quot; id &quot;</span> | get_field 2<span class="k">)</span>
            keystone endpoint-create <span class="se">\</span>
                --region RegionOne <span class="se">\</span>
                --service_id <span class="nv">$NOVA_V3_SERVICE</span> <span class="se">\</span>
                --publicurl <span class="s2">&quot;$NOVA_SERVICE_PROTOCOL://$NOVA_SERVICE_HOST:$NOVA_SERVICE_PORT/v3&quot;</span> <span class="se">\</span>
                --adminurl <span class="s2">&quot;$NOVA_SERVICE_PROTOCOL://$NOVA_SERVICE_HOST:$NOVA_SERVICE_PORT/v3&quot;</span> <span class="se">\</span>
                --internalurl <span class="s2">&quot;$NOVA_SERVICE_PROTOCOL://$NOVA_SERVICE_HOST:$NOVA_SERVICE_PORT/v3&quot;</span>
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>create_nova_conf() - Create a new nova.conf file</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>create_nova_conf<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Remove legacy <tt class="docutils literal">nova.conf</tt></p>
</td><td class=code><div class=highlight><pre>
    rm -f <span class="nv">$NOVA_DIR</span>/bin/nova.conf

</pre></div></td></tr><tr><td class=docs>
<p>(Re)create <tt class="docutils literal">nova.conf</tt></p>
</td><td class=code><div class=highlight><pre>
    rm -f <span class="nv">$NOVA_CONF</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT verbose <span class="s2">&quot;True&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT debug <span class="s2">&quot;$ENABLE_DEBUG_LOG_LEVEL&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT auth_strategy <span class="s2">&quot;keystone&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT allow_resize_to_same_host <span class="s2">&quot;True&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT api_paste_config <span class="s2">&quot;$NOVA_API_PASTE_INI&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT rootwrap_config <span class="s2">&quot;$NOVA_CONF_DIR/rootwrap.conf&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT scheduler_driver <span class="s2">&quot;$SCHEDULER&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT dhcpbridge_flagfile <span class="s2">&quot;$NOVA_CONF&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT force_dhcp_release <span class="s2">&quot;True&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT fixed_range <span class="s2">&quot;&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT default_floating_pool <span class="s2">&quot;$PUBLIC_NETWORK_NAME&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT s3_host <span class="s2">&quot;$SERVICE_HOST&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT s3_port <span class="s2">&quot;$S3_SERVICE_PORT&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT osapi_compute_extension <span class="s2">&quot;nova.api.openstack.compute.contrib.standard_extensions&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT my_ip <span class="s2">&quot;$HOST_IP&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT osapi_compute_workers <span class="s2">&quot;4&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT ec2_workers <span class="s2">&quot;4&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT metadata_workers <span class="s2">&quot;4&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT sql_connection <span class="sb">`</span>database_connection_url nova<span class="sb">`</span>
    <span class="k">if </span>is_baremetal; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$NOVA_CONF</span> baremetal sql_connection <span class="sb">`</span>database_connection_url nova_bm<span class="sb">`</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;libvirt&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT libvirt_type <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT libvirt_cpu_mode <span class="s2">&quot;none&quot;</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT use_usb_tablet <span class="s2">&quot;False&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT instance_name_template <span class="s2">&quot;${INSTANCE_NAME_PREFIX}%08x&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> osapi_v3 enabled <span class="s2">&quot;True&quot;</span>

    <span class="k">if </span>is_fedora; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>nova defaults to /usr/local/bin, but fedora pip likes to
install things in /usr/bin</p>
</td><td class=code><div class=highlight><pre>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT bindir <span class="s2">&quot;/usr/bin&quot;</span>
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled n-api; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT enabled_apis <span class="s2">&quot;$NOVA_ENABLED_APIS&quot;</span>
        <span class="k">if </span>is_service_enabled tls-proxy; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set the service port for a proxy to take the original</p>
</td><td class=code><div class=highlight><pre>
            iniset <span class="nv">$NOVA_CONF</span> DEFAULT osapi_compute_listen_port <span class="s2">&quot;$NOVA_SERVICE_PORT_INT&quot;</span>
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="k">    if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT volume_api_class <span class="s2">&quot;nova.volume.cinder.API&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[</span> -n <span class="s2">&quot;$NOVA_STATE_PATH&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT state_path <span class="s2">&quot;$NOVA_STATE_PATH&quot;</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT lock_path <span class="s2">&quot;$NOVA_STATE_PATH&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[</span> -n <span class="s2">&quot;$NOVA_INSTANCES_PATH&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT instances_path <span class="s2">&quot;$NOVA_INSTANCES_PATH&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$MULTI_HOST&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT multi_host <span class="s2">&quot;True&quot;</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT send_arp_for_ha <span class="s2">&quot;True&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$SYSLOG&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT use_syslog <span class="s2">&quot;True&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$API_RATE_LIMIT&quot;</span> !<span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT api_rate_limit <span class="s2">&quot;False&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$LOG_COLOR&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;$SYSLOG&quot;</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Add color to logging output</p>
</td><td class=code><div class=highlight><pre>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT logging_context_format_string <span class="s2">&quot;%(asctime)s.%(msecs)03d %(color)s%(levelname)s %(name)s [[01;36m%(request_id)s [00;36m%(user_name)s %(project_name)s%(color)s] [01;35m%(instance)s%(color)s%(message)s[00m&quot;</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT logging_default_format_string <span class="s2">&quot;%(asctime)s.%(msecs)03d %(color)s%(levelname)s %(name)s [[00;36m-%(color)s] [01;35m%(instance)s%(color)s%(message)s[00m&quot;</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT logging_debug_format_suffix <span class="s2">&quot;[00;33mfrom (pid=%(process)d) %(funcName)s %(pathname)s:%(lineno)d[00m&quot;</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT logging_exception_prefix <span class="s2">&quot;%(color)s%(asctime)s.%(msecs)03d TRACE %(name)s [01;35m%(instance)s[00m&quot;</span>
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Show user_name and project_name instead of user_id and project_id</p>
</td><td class=code><div class=highlight><pre>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT logging_context_format_string <span class="s2">&quot;%(asctime)s.%(msecs)03d %(levelname)s %(name)s [%(request_id)s %(user_name)s %(project_name)s] %(instance)s%(message)s&quot;</span>
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled ceilometer; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT instance_usage_audit <span class="s2">&quot;True&quot;</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT instance_usage_audit_period <span class="s2">&quot;hour&quot;</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT notify_on_state_change <span class="s2">&quot;vm_and_task_state&quot;</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Provide some transition from <tt class="docutils literal">EXTRA_FLAGS</tt> to <tt class="docutils literal">EXTRA_OPTS</tt></p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$EXTRA_OPTS&quot;</span> <span class="o">&amp;&amp;</span> -n <span class="s2">&quot;$EXTRA_FLAGS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">EXTRA_OPTS</span><span class="o">=</span><span class="nv">$EXTRA_FLAGS</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Define extra nova conf flags by defining the array <tt class="docutils literal">EXTRA_OPTS</tt>.
For Example: <tt class="docutils literal"><span class="pre">EXTRA_OPTS=(foo=true</span> bar=2)</tt></p>
</td><td class=code><div class=highlight><pre>
    <span class="k">for </span>I in <span class="s2">&quot;${EXTRA_OPTS[@]}&quot;</span>; <span class="k">do</span>
</pre></div></td></tr><tr><td class=docs>
<p>Replace the first '=' with ' ' for iniset syntax</p>
</td><td class=code><div class=highlight><pre>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT <span class="k">${</span><span class="nv">I</span><span class="p">/=/ </span><span class="k">}</span>
    <span class="k">done</span>

</pre></div></td></tr><tr><td class=docs>
<p>All nova-compute workers need to know the vnc configuration options
These settings don't hurt anything if n-xvnc and n-novnc are disabled</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled n-cpu; <span class="k">then</span>
<span class="k">        </span><span class="nv">NOVNCPROXY_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVNCPROXY_URL</span><span class="k">:-</span><span class="s2">&quot;http://$SERVICE_HOST:6080/vnc_auto.html&quot;</span><span class="k">}</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT novncproxy_base_url <span class="s2">&quot;$NOVNCPROXY_URL&quot;</span>
        <span class="nv">XVPVNCPROXY_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">XVPVNCPROXY_URL</span><span class="k">:-</span><span class="s2">&quot;http://$SERVICE_HOST:6081/console&quot;</span><span class="k">}</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT xvpvncproxy_base_url <span class="s2">&quot;$XVPVNCPROXY_URL&quot;</span>
        <span class="nv">SPICEHTML5PROXY_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">SPICEHTML5PROXY_URL</span><span class="k">:-</span><span class="s2">&quot;http://$SERVICE_HOST:6082/spice_auto.html&quot;</span><span class="k">}</span>
        iniset <span class="nv">$NOVA_CONF</span> spice html5proxy_base_url <span class="s2">&quot;$SPICEHTML5PROXY_URL&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="p">=169.254.0.1</span><span class="k">}</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="p">=127.0.0.1</span><span class="k">}</span>
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled n-novnc <span class="o">||</span> is_service_enabled n-xvnc; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Address on which instance vncservers will listen on compute hosts.
For multi-host, this should be the management ip of the compute host.</p>
</td><td class=code><div class=highlight><pre>
      <span class="nv">VNCSERVER_LISTEN</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_LISTEN</span><span class="p">=127.0.0.1</span><span class="k">}</span>
      iniset <span class="nv">$NOVA_CONF</span> DEFAULT vnc_enabled <span class="nb">true</span>
<span class="nb">      </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT vncserver_listen <span class="s2">&quot;$VNCSERVER_LISTEN&quot;</span>
      iniset <span class="nv">$NOVA_CONF</span> DEFAULT vncserver_proxyclient_address <span class="s2">&quot;$VNCSERVER_PROXYCLIENT_ADDRESS&quot;</span>
    <span class="k">else</span>
<span class="k">      </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT vnc_enabled <span class="nb">false</span>
<span class="nb">    </span><span class="k">fi</span>

<span class="k">    if </span>is_service_enabled n-spice; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Address on which instance spiceservers will listen on compute hosts.
For multi-host, this should be the management ip of the compute host.</p>
</td><td class=code><div class=highlight><pre>
      <span class="nv">SPICESERVER_PROXYCLIENT_ADDRESS</span><span class="o">=</span><span class="k">${</span><span class="nv">SPICESERVER_PROXYCLIENT_ADDRESS</span><span class="p">=127.0.0.1</span><span class="k">}</span>
      <span class="nv">SPICESERVER_LISTEN</span><span class="o">=</span><span class="k">${</span><span class="nv">SPICESERVER_LISTEN</span><span class="p">=127.0.0.1</span><span class="k">}</span>
      iniset <span class="nv">$NOVA_CONF</span> spice enabled <span class="nb">true</span>
<span class="nb">      </span>iniset <span class="nv">$NOVA_CONF</span> spice server_listen <span class="s2">&quot;$SPICESERVER_LISTEN&quot;</span>
      iniset <span class="nv">$NOVA_CONF</span> spice server_proxyclient_address <span class="s2">&quot;$SPICESERVER_PROXYCLIENT_ADDRESS&quot;</span>
    <span class="k">else</span>
<span class="k">      </span>iniset <span class="nv">$NOVA_CONF</span> spice enabled <span class="nb">false</span>
<span class="nb">    </span><span class="k">fi</span>

<span class="k">    </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT ec2_dmz_host <span class="s2">&quot;$EC2_DMZ_HOST&quot;</span>
    iniset_rpc_backend nova <span class="nv">$NOVA_CONF</span> DEFAULT
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT glance_api_servers <span class="s2">&quot;$GLANCE_HOSTPORT&quot;</span>
<span class="o">}</span>

<span class="k">function </span>init_nova_cells<span class="o">()</span> <span class="o">{</span>
    <span class="k">if </span>is_service_enabled n-cell; <span class="k">then</span>
<span class="k">        </span>cp <span class="nv">$NOVA_CONF</span> <span class="nv">$NOVA_CELLS_CONF</span>
        iniset <span class="nv">$NOVA_CELLS_CONF</span> DEFAULT sql_connection <span class="sb">`</span>database_connection_url <span class="nv">$NOVA_CELLS_DB</span><span class="sb">`</span>
        iniset <span class="nv">$NOVA_CELLS_CONF</span> DEFAULT rabbit_virtual_host child_cell
        iniset <span class="nv">$NOVA_CELLS_CONF</span> DEFAULT dhcpbridge_flagfile <span class="nv">$NOVA_CELLS_CONF</span>
        iniset <span class="nv">$NOVA_CELLS_CONF</span> cells <span class="nb">enable </span>True
        iniset <span class="nv">$NOVA_CELLS_CONF</span> cells cell_type compute
        iniset <span class="nv">$NOVA_CELLS_CONF</span> cells name child

        iniset <span class="nv">$NOVA_CONF</span> cells <span class="nb">enable </span>True
        iniset <span class="nv">$NOVA_CONF</span> cells cell_type api
        iniset <span class="nv">$NOVA_CONF</span> cells name region

        <span class="k">if </span>is_service_enabled n-api-meta; <span class="k">then</span>
<span class="k">            </span><span class="nv">NOVA_ENABLED_APIS</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$NOVA_ENABLED_APIS</span> | sed <span class="s2">&quot;s/,metadata//&quot;</span><span class="k">)</span>
            iniset <span class="nv">$NOVA_CONF</span> DEFAULT enabled_apis <span class="nv">$NOVA_ENABLED_APIS</span>
            iniset <span class="nv">$NOVA_CELLS_CONF</span> DEFAULT enabled_apis metadata
        <span class="k">fi</span>

        <span class="nv">$NOVA_BIN_DIR</span>/nova-manage --config-file <span class="nv">$NOVA_CELLS_CONF</span> db sync
        <span class="nv">$NOVA_BIN_DIR</span>/nova-manage --config-file <span class="nv">$NOVA_CELLS_CONF</span> cell create --name<span class="o">=</span>region --cell_type<span class="o">=</span>parent --username<span class="o">=</span>guest --hostname<span class="o">=</span><span class="nv">$RABBIT_HOST</span> --port<span class="o">=</span>5672 --password<span class="o">=</span><span class="nv">$RABBIT_PASSWORD</span> --virtual_host<span class="o">=</span>/ --woffset<span class="o">=</span>0 --wscale<span class="o">=</span>1
        <span class="nv">$NOVA_BIN_DIR</span>/nova-manage cell create --name<span class="o">=</span>child --cell_type<span class="o">=</span>child --username<span class="o">=</span>guest --hostname<span class="o">=</span><span class="nv">$RABBIT_HOST</span> --port<span class="o">=</span>5672 --password<span class="o">=</span><span class="nv">$RABBIT_PASSWORD</span> --virtual_host<span class="o">=</span>child_cell --woffset<span class="o">=</span>0 --wscale<span class="o">=</span>1
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>create_nova_cache_dir() - Part of the init_nova() process</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>create_nova_cache_dir<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create cache dir</p>
</td><td class=code><div class=highlight><pre>
    sudo mkdir -p <span class="nv">$NOVA_AUTH_CACHE_DIR</span>
    sudo chown <span class="nv">$STACK_USER</span> <span class="nv">$NOVA_AUTH_CACHE_DIR</span>
    rm -f <span class="nv">$NOVA_AUTH_CACHE_DIR</span>/*
<span class="o">}</span>

<span class="k">function </span>create_nova_conf_nova_network<span class="o">()</span> <span class="o">{</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT network_manager <span class="s2">&quot;nova.network.manager.$NETWORK_MANAGER&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT public_interface <span class="s2">&quot;$PUBLIC_INTERFACE&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT vlan_interface <span class="s2">&quot;$VLAN_INTERFACE&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT flat_network_bridge <span class="s2">&quot;$FLAT_NETWORK_BRIDGE&quot;</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$FLAT_INTERFACE&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT flat_interface <span class="s2">&quot;$FLAT_INTERFACE&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>create_nova_keys_dir() - Part of the init_nova() process</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>create_nova_keys_dir<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create keys dir</p>
</td><td class=code><div class=highlight><pre>
    sudo mkdir -p <span class="k">${</span><span class="nv">NOVA_STATE_PATH</span><span class="k">}</span>/keys
    sudo chown -R <span class="nv">$STACK_USER</span> <span class="k">${</span><span class="nv">NOVA_STATE_PATH</span><span class="k">}</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>init_nova() - Initialize databases, etc.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>init_nova<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>All nova components talk to a central database.
Only do this step once on the API node for an entire cluster.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled <span class="nv">$DATABASE_BACKENDS</span> <span class="o">&amp;&amp;</span> is_service_enabled n-api; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>(Re)create nova database
Explicitly use latin1: to avoid lp#829209, nova expects the database to
use latin1 by default, and then upgrades the database to utf8 (see the
082_essex.py in nova)</p>
</td><td class=code><div class=highlight><pre>
        recreate_database nova latin1

</pre></div></td></tr><tr><td class=docs>
<p>Migrate nova database</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">$NOVA_BIN_DIR</span>/nova-manage db sync

        <span class="k">if </span>is_service_enabled n-cell; <span class="k">then</span>
<span class="k">            </span>recreate_database <span class="nv">$NOVA_CELLS_DB</span> latin1
        <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>(Re)create nova baremetal database</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if </span>is_baremetal; <span class="k">then</span>
<span class="k">            </span>recreate_database nova_bm latin1
            <span class="nv">$NOVA_BIN_DIR</span>/nova-baremetal-manage db sync
        <span class="k">fi</span>
<span class="k">    fi</span>

<span class="k">    </span>create_nova_cache_dir
    create_nova_keys_dir
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>install_novaclient() - Collect source and prepare</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>install_novaclient<span class="o">()</span> <span class="o">{</span>
    git_clone <span class="nv">$NOVACLIENT_REPO</span> <span class="nv">$NOVACLIENT_DIR</span> <span class="nv">$NOVACLIENT_BRANCH</span>
    setup_develop <span class="nv">$NOVACLIENT_DIR</span>
    sudo install -D -m 0644 -o <span class="nv">$STACK_USER</span> <span class="o">{</span><span class="nv">$NOVACLIENT_DIR</span>/tools/,/etc/bash_completion.d/<span class="o">}</span>nova.bash_completion
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>install_nova() - Collect source and prepare</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>install_nova<span class="o">()</span> <span class="o">{</span>
    <span class="k">if </span>is_service_enabled n-cpu; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> -r <span class="nv">$NOVA_PLUGINS</span>/hypervisor-<span class="nv">$VIRT_DRIVER</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>install_nova_hypervisor
        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;libvirt&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if </span>is_ubuntu; <span class="k">then</span>
<span class="k">                </span>install_package kvm
                install_package libvirt-bin
                install_package python-libvirt
            <span class="k">elif </span>is_fedora <span class="o">||</span> is_suse; <span class="k">then</span>
<span class="k">                </span>install_package kvm
                install_package libvirt
                install_package libvirt-python
            <span class="k">else</span>
<span class="k">                </span>exit_distro_not_supported <span class="s2">&quot;libvirt installation&quot;</span>
            <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install and configure <strong>LXC</strong> if specified.  LXC is another approach to
splitting a system into many smaller parts.  LXC uses cgroups and chroot
to simulate multiple systems.</p>
</td><td class=code><div class=highlight><pre>
            <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;lxc&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                if </span>is_ubuntu; <span class="k">then</span>
<span class="k">                    if</span> <span class="o">[[</span> <span class="s2">&quot;$DISTRO&quot;</span> &gt; natty <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                        </span>install_package cgroup-lite
                    <span class="k">fi</span>
<span class="k">                else</span>
                    <span class="c">### FIXME(dtroyer): figure this out</span>
                    <span class="nb">echo</span> <span class="s2">&quot;RPM-based cgroup not implemented yet&quot;</span>
                    yum_install libcgroup-tools
                <span class="k">fi</span>
<span class="k">            fi</span>
<span class="k">        fi</span>
<span class="k">    fi</span>

<span class="k">    </span>git_clone <span class="nv">$NOVA_REPO</span> <span class="nv">$NOVA_DIR</span> <span class="nv">$NOVA_BRANCH</span>
    setup_develop <span class="nv">$NOVA_DIR</span>
    sudo install -D -m 0644 -o <span class="nv">$STACK_USER</span> <span class="o">{</span><span class="nv">$NOVA_DIR</span>/tools/,/etc/bash_completion.d/<span class="o">}</span>nova-manage.bash_completion
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>start_nova_api() - Start the API process ahead of other things</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>start_nova_api<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Get right service port for testing</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">local </span><span class="nv">service_port</span><span class="o">=</span><span class="nv">$NOVA_SERVICE_PORT</span>
    <span class="k">if </span>is_service_enabled tls-proxy; <span class="k">then</span>
<span class="k">        </span><span class="nv">service_port</span><span class="o">=</span><span class="nv">$NOVA_SERVICE_PORT_INT</span>
    <span class="k">fi</span>

<span class="k">    </span>screen_it n-api <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-api&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for nova-api to start...&quot;</span>
    <span class="k">if</span> ! wait_for_service <span class="nv">$SERVICE_TIMEOUT</span> http://<span class="nv">$SERVICE_HOST</span>:<span class="nv">$service_port</span>; <span class="k">then</span>
<span class="k">      </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;nova-api did not start&quot;</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Start proxies if enabled</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled tls-proxy; <span class="k">then</span>
<span class="k">        </span>start_tls_proxy <span class="s1">&#39;*&#39;</span> <span class="nv">$NOVA_SERVICE_PORT</span> <span class="nv">$NOVA_SERVICE_HOST</span> <span class="nv">$NOVA_SERVICE_PORT_INT</span> &amp;
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>start_nova() - Start running processes, including screen</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>start_nova<span class="o">()</span> <span class="o">{</span>
    <span class="nv">NOVA_CONF_BOTTOM</span><span class="o">=</span><span class="nv">$NOVA_CONF</span>

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">screen_it</tt> checks <tt class="docutils literal">is_service_enabled</tt>, it is not needed here</p>
</td><td class=code><div class=highlight><pre>
    screen_it n-cond <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-conductor&quot;</span>

    <span class="k">if </span>is_service_enabled n-cell; <span class="k">then</span>
<span class="k">        </span><span class="nv">NOVA_CONF_BOTTOM</span><span class="o">=</span><span class="nv">$NOVA_CELLS_CONF</span>
        screen_it n-cond <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-conductor --config-file $NOVA_CELLS_CONF&quot;</span>
        screen_it n-cell-region <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-cells --config-file $NOVA_CONF&quot;</span>
        screen_it n-cell-child <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-cells --config-file $NOVA_CELLS_CONF&quot;</span>
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;libvirt&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>The group <strong>$LIBVIRT_GROUP</strong> is added to the current user in this script.
Use 'sg' to execute nova-compute as a member of the <strong>$LIBVIRT_GROUP</strong> group.</p>
</td><td class=code><div class=highlight><pre>
        screen_it n-cpu <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; sg $LIBVIRT_GROUP &#39;$NOVA_BIN_DIR/nova-compute --config-file $NOVA_CONF_BOTTOM&#39;&quot;</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;fake&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">       for </span>i in <span class="sb">`</span>seq 1 <span class="nv">$NUMBER_FAKE_NOVA_COMPUTE</span><span class="sb">`</span>
       <span class="k">do</span>
<span class="k">           </span>screen_it n-cpu <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-compute --config-file $NOVA_CONF_BOTTOM&quot;</span>
       <span class="k">done</span>
<span class="k">    else</span>
<span class="k">        if </span>is_service_enabled n-cpu <span class="o">&amp;&amp;</span> <span class="o">[[</span> -r <span class="nv">$NOVA_PLUGINS</span>/hypervisor-<span class="nv">$VIRT_DRIVER</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>start_nova_hypervisor
        <span class="k">fi</span>
<span class="k">        </span>screen_it n-cpu <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-compute --config-file $NOVA_CONF_BOTTOM&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span>screen_it n-crt <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-cert&quot;</span>
    screen_it n-net <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-network --config-file $NOVA_CONF_BOTTOM&quot;</span>
    screen_it n-sch <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-scheduler --config-file $NOVA_CONF_BOTTOM&quot;</span>
    screen_it n-api-meta <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-api-metadata --config-file $NOVA_CONF_BOTTOM&quot;</span>

    screen_it n-novnc <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-novncproxy --config-file $NOVA_CONF --web $NOVNC_DIR&quot;</span>
    screen_it n-xvnc <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-xvpvncproxy --config-file $NOVA_CONF&quot;</span>
    screen_it n-spice <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-spicehtml5proxy --config-file $NOVA_CONF --web $SPICE_DIR&quot;</span>
    screen_it n-cauth <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-consoleauth&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Starting the nova-objectstore only if swift3 service is not enabled.
Swift will act as s3 objectstore.</p>
</td><td class=code><div class=highlight><pre>
    is_service_enabled swift3 <span class="o">||</span> <span class="se">\</span>
        screen_it n-obj <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-objectstore&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>stop_nova() - Stop running processes (non-screen)</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>stop_nova<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Kill the nova screen windows
Some services are listed here twice since more than one instance
of a service may be running in certain configs.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">for </span>serv in n-api n-cpu n-crt n-net n-sch n-novnc n-xvnc n-cauth n-spice n-cond n-cond n-cell n-cell n-api-meta; <span class="k">do</span>
<span class="k">        </span>screen -S <span class="nv">$SCREEN_NAME</span> -p <span class="nv">$serv</span> -X <span class="nb">kill</span>
<span class="nb">    </span><span class="k">done</span>
<span class="k">    if </span>is_service_enabled n-cpu <span class="o">&amp;&amp;</span> <span class="o">[[</span> -r <span class="nv">$NOVA_PLUGINS</span>/hypervisor-<span class="nv">$VIRT_DRIVER</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>stop_nova_hypervisor
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Restore xtrace</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">$XTRACE</span>

</pre></div></td></tr><tr><td class=docs>
<p>Local variables:
mode: shell-script
End:</p>
</td><td class=code><div class=highlight><pre>


</td><td class=code><div class=highlight><pre>
</pre></div></td></tr><tr><td class=docs>
</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
